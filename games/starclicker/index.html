<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>å®‡å®™ã‚¯ãƒªãƒƒã‚«ãƒ¼ã‚²ãƒ¼ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            color: #e0e7ff; /* Light text color */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Prevent scroll */
            user-select: none; /* Disable text selection */
            -webkit-user-select: none; /* For Safari */
            -moz-user-select: none; /* For Firefox */
            -ms-user-select: none; /* For IE/Edge */
            cursor: default; /* Change cursor to default pointer */

            /* Base gradient and some subtle nebula effects */
            background:
                radial-gradient(circle at 10% 20%, rgba(30, 30, 80, 0.5) 0%, transparent 60%),
                radial-gradient(circle at 90% 80%, rgba(50, 20, 70, 0.5) 0%, transparent 60%),
                linear-gradient(to bottom, #0a0a0f, #1a1a2e); /* Main dark background */
        }

        /* Pseudo-elements for star layers */
        body::before, body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Behind content */
            background-repeat: repeat;
        }

        /* Layer 1: Distant, small, dense stars */
        body::before {
            background-image: radial-gradient(1.5px 1.5px at 10% 20%, #fff, transparent),
                              radial-gradient(1.5px 1.5px at 30% 70%, #fff, transparent),
                              radial-gradient(1.5px 1.5px at 60% 10%, #fff, transparent),
                              radial-gradient(1.5px 1.5px at 80% 90%, #fff, transparent),
                              radial-gradient(1.5px 1.5px at 5% 50%, #fff, transparent),
                              radial-gradient(1.5px 1.5px at 40% 40%, #fff, transparent);
            background-size: 800px 800px;
            animation: star-move-1 120s linear infinite;
        }

        /* Layer 2: Medium-sized, less dense stars */
        body::after {
            background-image: radial-gradient(2.5px 2.5px at 15% 85%, #fff, transparent),
                              radial-gradient(2.5px 2.5px at 70% 30%, #fff, transparent),
                              radial-gradient(2.5px 2.5px at 25% 60%, #fff, transparent),
                              radial-gradient(2.5px 2.5px at 95% 5%, #fff, transparent);
            background-size: 1500px 1500px;
            animation: star-move-2 200s linear infinite; /* Slower */
        }

        @keyframes star-move-1 {
            from { background-position: 0 0; }
            to { background-position: 800px 800px; }
        }

        @keyframes star-move-2 {
            from { background-position: 0 0; }
            to { background-position: -1500px -1500px; } /* Different direction */
        }

        .container {
            max-width: 90%;
            width: 100%;
            background-color: rgba(26, 26, 46, 0.8); /* Slightly transparent dark background */
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            height: 90vh; /* Maximize vertical space */
            margin: 20px auto;
        }
        .menu-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
        }
        .sidebar {
            width: 250px;
            min-width: 250px;
            background-color: #2a2a4a; /* Darker sidebar */
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 90;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            padding-top: 80px; /* Space for menu button */
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .sidebar.open {
            transform: translateX(0);
        }

        /* New Upgrade Sidebar */
        .upgrades-sidebar {
            width: 300px; /* Slightly wider for upgrades */
            min-width: 300px;
            background-color: #2a2a4a; /* Darker sidebar */
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 950; /* Higher than main sidebar, lower than modals */
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            padding: 20px;
            border-top-left-radius: 20px;
            border-bottom-left-radius: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        .upgrades-sidebar.open {
            transform: translateX(0);
        }
        .upgrades-sidebar-content {
            flex-grow: 1;
            overflow-y: auto; /* Allow scrolling for upgrade list */
            padding-right: 10px; /* Space for scrollbar */
        }
        .upgrades-sidebar .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
        }


        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; /* Allow scrolling for content */
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .star-clicker {
            width: 200px;
            height: 200px;
            font-size: 150px; /* Star emoji size */
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s ease-out;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: pulse 2s infinite; /* Pulsing effect for the star */
        }
        .star-clicker:active {
            transform: scale(0.95);
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .upgrade-item {
            background-color: #3b3b6b;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column; /* Changed to column for better layout with batch buttons */
            align-items: flex-start; /* Align content to the start */
            justify-content: space-between;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .upgrade-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px; /* Space before buttons */
        }
        .upgrade-actions {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap */
            gap: 5px; /* Space between buttons */
            width: 100%;
            justify-content: flex-end; /* Align buttons to the right */
        }
        .upgrade-actions button {
            background-color: #6a6aff;
            color: white;
            padding: 8px 12px; /* Smaller padding for batch buttons */
            border-radius: 8px; /* Slightly smaller radius */
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2); /* Smaller shadow */
            font-size: 0.85rem; /* Smaller font size */
            flex-grow: 1; /* Allow buttons to grow */
            min-width: 50px; /* Minimum width for small buttons */
        }
        .upgrade-actions button:hover {
            background-color: #4a4acb;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        /* Explicitly for disabled state to override default hover/active */
        .upgrade-actions button[disabled] {
            background-color: #6b7280 !important; /* Tailwind gray-500, use !important to ensure override */
            cursor: not-allowed !important;
            pointer-events: none; /* Disables all mouse events, including hover */
            box-shadow: none !important; /* Remove shadow when disabled */
            opacity: 0.7; /* Slightly dim it */
        }
        .upgrade-icon {
            font-size: 2.5em; /* Larger icon */
            margin-right: 15px; /* Space between icon and text */
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #2a2a4a;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
            position: relative; /* For close button positioning */
        }
        .modal.open .modal-content {
            transform: translateY(0);
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            color: #ccc;
            cursor: pointer;
            padding: 5px;
        }
        .modal-button {
            background-color: #ff6b6b;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            margin: 10px;
            transition: background-color 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .modal-button.confirm {
            background-color: #6aff6a;
        }
        .modal-button:hover {
            background-color: #e04a4a;
        }
        .modal-button.confirm:hover {
            background-color: #4acb4a;
        }

        /* Release Notes and Credits specific styles */
        .release-notes-content, .credits-content, .inventory-content, .excavation-content {
            text-align: left;
            max-height: 400px; /* Limit height for scrolling */
            overflow-y: auto;
            padding: 10px;
            background-color: #1a1a2e;
            border-radius: 10px;
            margin-top: 20px;
        }
        .release-notes-item, .credits-item, .inventory-item, .excavation-planet-item {
            background-color: #2a2a4a;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .release-notes-item:last-child, .credits-item:last-child, .inventory-item:last-child, .excavation-planet-item:last-child {
            margin-bottom: 0;
        }
        .release-notes-item h4, .credits-item h4, .inventory-item h4, .excavation-planet-item h4 {
            font-size: 1.1em;
            font-weight: bold;
            color: #93c5fd; /* blue-300 */
            margin-bottom: 5px;
        }
        .release-notes-item p, .credits-item p, .inventory-item p, .excavation-planet-item p {
            font-size: 0.9em;
            color: #cbd5e1; /* slate-300 */
        }

        /* Volume slider specific styles */
        .volume-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
            color: #e0e7ff;
        }
        .volume-control input[type="range"] {
            width: 70%;
            -webkit-appearance: none;
            height: 8px;
            background: #4a4a6b;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .volume-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #6a6aff;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .volume-control input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #6a6aff;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .volume-icon svg {
            width: 24px;
            height: 24px;
            transition: color 0.2s ease-in-out; /* Smooth color transition for icon */
        }

        /* Excavation cooldown bar */
        .cooldown-bar-wrapper {
            width: 100%;
            background-color: #4a4a6b;
            border-radius: 5px;
            overflow: hidden;
            height: 10px;
            margin-top: 5px;
        }
        .cooldown-bar {
            height: 100%;
            background-color: #6a6aff;
            width: 0%;
            transition: width 0.1s linear; /* Smooth transition for bar fill */
        }

        .excavation-cooldown-display {
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
            font-size: 0.9em;
            color: #cbd5e1;
            margin-top: 5px;
            text-align: center;
        }

        /* Batch buy button container */
        .batch-buy-controls {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: rgba(42, 42, 74, 0.8);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .batch-cycle-button {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
            text-align: center;
            color: white;
            background-color: #6a6aff; /* Default color */
        }
        .batch-cycle-button:hover {
            background-color: #4a4acb;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .batch-cycle-button:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <!-- Hamburger Menu Button -->
    <button id="menu-button" class="menu-button p-3 rounded-full bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-200">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <!-- Sidebar Navigation (Left) -->
    <nav id="sidebar" class="sidebar fixed top-0 left-0 w-64 h-full bg-gray-900 shadow-lg text-white p-6 transform -translate-x-full transition-transform duration-300 ease-in-out z-50 rounded-r-lg">
        <ul class="space-y-4 pt-10">
            <li>
                <a href="#" class="block px-4 py-2 text-lg font-semibold rounded-md hover:bg-gray-700 transition duration-200" data-modal="upgrades-sidebar-modal" data-scroll-to="regular-upgrades-section">å…¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</a>
            </li>
            <li>
                <a href="#" class="block px-4 py-2 text-lg font-semibold rounded-md hover:bg-gray-700 transition duration-200" data-modal="upgrades-sidebar-modal" data-scroll-to="one-time-upgrades-section">ç‰¹åˆ¥ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</a>
            </li>
            <li>
                <a href="#" id="breakthrough-menu-link" class="block px-4 py-2 text-lg font-semibold rounded-md hover:bg-gray-700 transition duration-200" data-modal="upgrades-sidebar-modal" data-scroll-to="breakthrough-upgrades-section" style="display: none;">é™ç•Œçªç ´</a>
            </li>
            <li>
                <a href="#" class="block px-4 py-2 text-lg font-semibold rounded-md hover:bg-gray-700 transition duration-200" data-modal="inventory-modal">ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</a>
            </li>
            <li>
                <a href="#" id="excavation-menu-link" class="block px-4 py-2 text-lg font-semibold rounded-md hover:bg-gray-700 transition duration-200" data-modal="excavation-modal" style="display: none;">æƒ‘æ˜Ÿæ¡æ˜</a>
            </li>
            <li>
                <a href="#" class="block px-4 py-2 text-lg font-semibold rounded-md hover:bg-gray-700 transition duration-200" data-modal="settings-modal">è¨­å®š</a>
            </li>
            <li>
                <a href="#" class="block px-4 py-2 text-lg font-semibold rounded-md hover:bg-gray-700 transition duration-200" data-action="rebig-bang">ãƒªãƒ“ãƒƒã‚°ãƒãƒ³</a>
            </li>
        </ul>
    </nav>

    <div class="container relative flex flex-col md:flex-row items-stretch overflow-hidden">
        <!-- Main Content Area -->
        <main class="main-content flex-grow p-6">
            <!-- Game Section -->
            <section id="game" class="section active flex flex-col items-center justify-center h-full text-center relative">
                <h1 class="text-4xl md:text-5xl font-bold mb-6 text-blue-300">ã‚¹ã‚¿ãƒ¼ã‚¯ãƒªãƒƒã‚¯ï¼</h1>
                <p class="text-2xl mb-4">
                    æ˜Ÿã‹ã‚‰ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼: <br> <span id="energy-display" class="font-bold text-yellow-300">0</span>
                </p>

                <div id="star-clicker" class="star-clicker flex justify-center items-center rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 shadow-xl border-4 border-yellow-200 cursor-pointer select-none mx-auto relative z-20">
                    â­
                </div>
                <div class="flex flex-wrap justify-center gap-4 mt-8">
                    <p class="text-lg font-medium bg-gray-700 rounded-lg p-2 px-4 shadow-md">ã‚¯ãƒªãƒƒã‚¯ãƒ‘ãƒ¯ãƒ¼: <span id="click-power-display">1</span></p>
                    <p class="text-lg font-medium bg-gray-700 rounded-lg p-2 px-4 shadow-md">è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯: <span id="auto-click-display">0</span>/ç§’</p>
                    <!-- Heat Clicker Multiplier Display -->
                    <p id="heat-clicker-display-wrapper" class="text-lg font-medium bg-gray-700 rounded-lg p-2 px-4 shadow-md" style="display: none;">ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚¯: <span id="heat-multiplier-display" class="font-bold" style="color: hsl(0, 0%, 100%);">1.0x</span></p>
                    <!-- Excavation Cooldown Display (appears when excavationLicense is purchased) -->
                    <p id="excavation-cooldown-display-wrapper" class="text-lg font-medium bg-gray-700 rounded-lg p-2 px-4 shadow-md" style="display: none;">æ¡æ˜ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³: <span id="excavation-cooldown-display" class="font-bold">æº–å‚™å®Œäº†</span></p>
                </div>
            </section>
        </main>
    </div>

    <!-- Upgrades Sidebar Modal (Right) -->
    <div id="upgrades-sidebar-modal" class="upgrades-sidebar">
        <button class="modal-close-button" data-action="close-modal">&times;</button>
        <h2 class="text-3xl md:text-4xl font-bold mb-8 text-purple-300 text-center">ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</h2>

        <!-- Batch Buy Controls -->
        <div class="batch-buy-controls">
            <button id="batch-cycle-button" class="batch-cycle-button">è³¼å…¥é‡: x1</button>
        </div>

        <div class="upgrades-sidebar-content">
            <h3 id="regular-upgrades-section" class="text-xl font-bold mb-4 mt-6 text-gray-300">æƒ‘æ˜Ÿã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</h3>
            <div id="regular-upgrade-list" class="grid grid-cols-1 gap-6">
                <!-- Regular Upgrade items will be dynamically inserted here -->
            </div>
            <h3 id="one-time-upgrades-section" class="text-xl font-bold mb-4 mt-6 text-gray-300">ç‰¹åˆ¥ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</h3>
            <div id="one-time-upgrade-list" class="grid grid-cols-1 gap-6">
                <!-- One-Time Upgrade items will be dynamically inserted here -->
            </div>
            <h3 id="breakthrough-upgrades-section" class="text-xl font-bold mb-4 mt-6 text-gray-300" style="display: none;">é™ç•Œçªç ´</h3>
            <div id="breakthrough-upgrade-list" class="grid grid-cols-1 gap-6">
                <!-- Breakthrough Upgrade items will be dynamically inserted here -->
            </div>
        </div>
        <button id="close-upgrades-sidebar" class="mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-200 text-xl">
            é–‰ã˜ã‚‹
        </button>
    </div>

    <!-- Inventory Modal -->
    <div id="inventory-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-button" data-action="close-modal">&times;</button>
            <h2 class="text-3xl md:text-4xl font-bold mb-8 text-yellow-300 text-center">ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</h2>
            <div id="inventory-content" class="inventory-content">
                <!-- Inventory items will be dynamically inserted here -->
            </div>
            <button id="close-inventory-modal" class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <!-- Excavation Modal -->
    <div id="excavation-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-button" data-action="close-modal">&times;</button>
            <h2 class="text-3xl md:text-4xl font-bold mb-8 text-orange-300 text-center">æƒ‘æ˜Ÿæ¡æ˜</h2>
            <div id="excavation-planet-list" class="excavation-content">
                <!-- Excavation planet items will be dynamically inserted here -->
            </div>
            <button id="close-excavation-modal" class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>


    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-button" data-action="close-modal">&times;</button>
            <p id="modal-message" class="text-xl mb-6 text-gray-200">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel" class="modal-button bg-gray-500 hover:bg-gray-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modal-confirm" class="modal-button confirm bg-red-600 hover:bg-red-700">ã¯ã„ã€å‰Šé™¤ã—ã¾ã™</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-button" data-action="close-modal">&times;</button>
            <h2 class="text-3xl md:text-4xl font-bold mb-8 text-red-300 text-center">è¨­å®š</h2>

            <!-- Volume Control -->
            <div class="volume-control">
                <span id="speaker-icon" class="volume-icon cursor-pointer">
                    <!-- SVG for volume icon, dynamically updated -->
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor">
                        <path d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77zM3 9v6h4l5 5V4L7 9H3z"/>
                    </svg>
                </span>
                <input type="range" id="volume-slider" min="0" max="100" value="50">
            </div>

            <button id="release-notes-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-200 text-xl mb-4">
                ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
            </button>
            <button id="credits-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-200 text-xl mb-4">
                ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ
            </button>
            <button id="delete-data-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-200 text-xl mb-4">
                ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            </button>
            <button id="close-settings-modal" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <!-- Release Notes Modal -->
    <div id="release-notes-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-button" data-action="close-modal">&times;</button>
            <h2 class="text-3xl md:text-4xl font-bold mb-8 text-blue-300 text-center">ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ</h2>
            <div id="release-notes-content" class="release-notes-content">
                <!-- Release notes will be dynamically inserted here -->
            </div>
            <button id="close-release-notes-modal" class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <!-- Credits Modal -->
    <div id="credits-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-button" data-action="close-modal">&times;</button>
            <h2 class="text-3xl md:text-4xl font-bold mb-8 text-green-300 text-center">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</h2>
            <div id="credits-content" class="credits-content">
                <!-- Credits will be dynamically inserted here -->
            </div>
            <button id="close-credits-modal" class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-200">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <!-- Audio Element -->
    <audio id="background-music" loop src="https://minntogames.github.io/minnntogames.github.io2/edge.wav"></audio>

    <script>
        // IndexedDBè¨­å®š
        const DB_NAME = 'SpaceClickerDB';
        const STORE_NAME = 'gameState';
        const DB_VERSION = 1;
        const BASE_STRONG_START_ENERGY_REQUIREMENT = 1000000; // 100ä¸‡ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒåŸºæœ¬ã‚³ã‚¹ãƒˆ
        const MAX_INACTIVITY_MS = 24 * 60 * 60 * 1000; // 24æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
        const HEAT_CLICKER_RESET_TIME_MS = 2000; // 2ç§’é–“ã®éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚«ãƒ¼ã®å€ç‡ã‚’ãƒªã‚»ãƒƒãƒˆ
        const HEAT_CLICKER_INCREMENT = 0.1; // ã‚¯ãƒªãƒƒã‚¯ã”ã¨ã«å€ç‡ãŒã“ã®é‡ã ã‘å¢—åŠ 
        let MAX_HEAT_CLICK_MULTIPLIER = 2.0; // ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚«ãƒ¼å€ç‡ã®æœ€å¤§åˆ¶é™ (é™ç•Œçªç ´ã§å¤‰å‹•)
        const EXCAVATION_MIN_PLANET_LEVEL = 20; // æ¡æ˜å¯èƒ½ãªæƒ‘æ˜Ÿã®æœ€ä½ãƒ¬ãƒ™ãƒ«

        // æ–°ã—ã„æƒ‘æ˜Ÿã®å®šç¾© (wideRangeTransfer ã§ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹)
        const newPlanetsData = {
            cometA: { level: 0, cost: 5e6, clickBonus: 1000, autoBonus: 10000, icon: 'â˜„ï¸', excavationCooldown: 240 * 1000 }, // 4åˆ†
            dwarfPlanet: { level: 0, cost: 1e7, clickBonus: 2000, autoBonus: 20000, icon: 'ğŸª', excavationCooldown: 300 * 1000 },  // 5åˆ†
            gasGiantMoon: { level: 0, cost: 5e7, clickBonus: 5000, autoBonus: 50000, icon: 'ğŸŒ•', excavationCooldown: 480 * 1000 } // 8åˆ†
        };

        let db; // IndexedDBãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        let gameState = {
            energy: 0, // é–‹ç™ºç”¨ã«1e101ã«è¨­å®šã—ã¦ã„ã¾ã—ãŸãŒã€0ã«æˆ»ã—ã¾ã™
            clickPower: 1,
            autoClickPower: 0,
            strongStartLevel: 0, // å¼·åŠ›ãªã‚¹ã‚¿ãƒ¼ãƒˆãŒä½•å›é–‹å§‹ã•ã‚ŒãŸã‹ã‚’è¿½è·¡
            lastPlayedTime: Date.now(), // æœ€å¾Œã®æ´»å‹•æ™‚é–“ã‚’ä¿å­˜
            heatClickMultiplier: 1.0, // ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚«ãƒ¼ã®å€ç‡
            lastClickTime: Date.now(), // æ˜ŸãŒæœ€å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚é–“
            selectedBatchAmount: 1, // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒãƒƒãƒè³¼å…¥é‡ (x1, x10, etc.)
            upgrades: {
                mercury: { level: 0, cost: 10, clickBonus: 1, autoBonus: 0, icon: 'â˜¿', excavationCooldown: 10 * 1000 }, // 10ç§’
                venus: { level: 0, cost: 50, clickBonus: 3, autoBonus: 0, icon: 'â™€', excavationCooldown: 15 * 1000 }, // 15ç§’
                earth: { level: 0, cost: 200, clickBonus: 0, autoBonus: 5, icon: 'ğŸŒ', excavationCooldown: 20 * 1000 }, // 20ç§’
                mars: { level: 0, cost: 1000, clickBonus: 10, autoBonus: 0, icon: 'â™‚', excavationCooldown: 30 * 1000 }, // 30ç§’
                jupiter: { level: 0, cost: 5000, clickBonus: 0, autoBonus: 50, icon: 'â™ƒ', excavationCooldown: 45 * 1000 }, // 45ç§’
                saturn: { level: 0, cost: 25000, clickBonus: 0, autoBonus: 200, icon: 'â™„', excavationCooldown: 60 * 1000 }, // 60ç§’ (1åˆ†)
                uranus: { level: 0, cost: 100000, clickBonus: 50, autoBonus: 0, icon: 'â›¢', excavationCooldown: 90 * 1000 }, // 90ç§’ (1.5åˆ†)
                neptune: { level: 0, cost: 500000, clickBonus: 0, autoBonus: 1000, icon: 'â™†', excavationCooldown: 120 * 1000 }, // 120ç§’ (2åˆ†)
                originalPlanetX: { level: 0, cost: 2000000, clickBonus: 500, autoBonus: 5000, icon: 'ğŸª', excavationCooldown: 180 * 1000 }, // 180ç§’ (3åˆ†)
                // æ–°ã—ã„ä¸€å›é™ã‚Šã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                cosmicDrill: { level: 0, initialCost: 1e7, cost: 1e7, clickBonus: 10000, autoBonus: 0, icon: 'â›ï¸', maxLevel: 1 },
                galacticReactor: { level: 0, initialCost: 5e7, cost: 5e7, clickBonus: 0, autoBonus: 10000, icon: 'âš›ï¸', maxLevel: 1 },
                heatClicker: { level: 0, initialCost: 1e6, cost: 1e6, clickBonus: 0, autoBonus: 0, icon: 'ğŸ”¥', maxLevel: 1, currentMaxMultiplier: 2.0 }, // ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚«ãƒ¼
                excavationLicense: { level: 0, initialCost: 1e5, cost: 1e5, clickBonus: 0, autoBonus: 0, icon: 'ğŸ“œ', maxLevel: 1 }, // æ¡æ˜ãƒ©ã‚¤ã‚»ãƒ³ã‚¹
                wideRangeTransfer: { level: 0, initialCost: 1e8, cost: 1e8, clickBonus: 0, autoBonus: 0, icon: 'ğŸ“¡', maxLevel: 1, unlockedPlanets: [], breakthroughLevel: 0 }, // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸæƒ‘æ˜Ÿã‚’è¿½è·¡, é™ç•Œçªç ´ãƒ¬ãƒ™ãƒ«
                // é™ç•Œçªç ´ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                heatClickerBreakthrough: { level: 0, initialCost: 1e6, cost: 1e6, itemCost: { ironOre: 100, silverOre: 10 }, targetUpgrade: 'heatClicker', maxLevel: 5, icon: 'ğŸ’¥', effect: 0.2, type: 'breakthrough' }, // ã‚¢ã‚¤ãƒ†ãƒ æ¶ˆè²»ã‚’ä¼´ã†é™ç•Œçªç ´, åŠ¹æœé‡
                wideRangeTransferBreakthrough: { level: 0, initialCost: 5e6, cost: 5e6, itemCost: { goldOre: 5, copperOre: 500 }, targetUpgrade: 'wideRangeTransfer', maxLevel: 3, icon: 'âš¡', unlocks: [ 'cometA', 'dwarfPlanet', 'gasGiantMoon' ], type: 'breakthrough' } // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã™ã‚‹æƒ‘æ˜Ÿã®ãƒªã‚¹ãƒˆ
            },
            volume: 0.5, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³é‡ (0.0 ã‹ã‚‰ 1.0)
            inventory: { // ãƒ†ã‚¹ãƒˆç”¨ã«ã„ãã¤ã‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
                ironOre: 0,
                copperOre: 0,
                silverOre: 0,
                goldOre: 0
            },
            planetExcavationCooldowns: {} // å„æƒ‘æ˜Ÿã®æ¡æ˜ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ™‚é–“
        };

        // ã‚¢ã‚¤ãƒ†ãƒ ã®å®šç¾©
        const itemData = {
            ironOre: { name: 'é‰„é‰±çŸ³', icon: 'ğŸª¨' },
            copperOre: { name: 'éŠ…é‰±çŸ³', icon: 'ğŸª¨' },
            silverOre: { name: 'éŠ€é‰±çŸ³', icon: 'âœ¨' },
            goldOre: { name: 'é‡‘é‰±çŸ³', icon: 'ğŸŒŸ' }
        };

        // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿
        const releaseNotesData = [
            { version: "v1.8", date: "2024-06-20", notes: "ãƒãƒƒãƒè³¼å…¥ãƒœã‚¿ãƒ³ã‚’å˜ä¸€ã®ãƒœã‚¿ãƒ³ã«çµ±åˆã—ã€ã‚¯ãƒªãƒƒã‚¯ã§è³¼å…¥é‡ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ã€Œé™ç•Œçªç ´ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚é™ç•Œçªç ´ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ã‚³ã‚¹ãƒˆè¡¨ç¤ºã‚’æ”¹å–„ã—ã¾ã—ãŸã€‚ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚«ãƒ¼ã®å€ç‡è¡¨ç¤ºã®è‰²èª¿æ•´ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚" },
            { version: "v1.7", date: "2024-06-20", notes: "æ–°ã—ã„ç‰¹æ®Šã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã€Œé™ç•Œçªç ´ã€ã¨ã€Œåºƒç¯„å›²è»¢é€è£…ç½®ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã€Œé™ç•Œçªç ´ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚é™ç•Œçªç ´ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ã‚³ã‚¹ãƒˆè¡¨ç¤ºã‚’æ”¹å–„ã—ã¾ã—ãŸã€‚ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚«ãƒ¼ã®å€ç‡è¡¨ç¤ºã®è‰²èª¿æ•´ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ãƒãƒƒãƒè³¼å…¥UIã‚’ä¸€å…ƒåŒ–ã—ã¾ã—ãŸã€‚" },
            { version: "v1.6", date: "2024-06-20", notes: "æ–°ã—ã„ç‰¹æ®Šã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã€Œé™ç•Œçªç ´ã€ã¨ã€Œåºƒç¯„å›²è»¢é€è£…ç½®ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ãƒãƒƒãƒè³¼å…¥UIã‚’æ”¹å–„ã—ã€ä¸€å…ƒåŒ–ã—ã¾ã—ãŸã€‚" },
            { version: "v1.5", date: "2024-06-20", notes: "æƒ‘æ˜Ÿæ¡æ˜ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æƒ‘æ˜Ÿã®ã‚³ã‚¹ãƒˆã«å¿œã˜ã¦å‹•çš„ã«è¨­å®šã—ã¾ã—ãŸã€‚ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã«ãƒãƒƒãƒãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ï¼ˆ+1, +10, +50, +100, Maxï¼‰ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚" },
            { version: "v1.4", date: "2024-06-20", notes: "æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã¨æƒ‘æ˜Ÿæ¡æ˜æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚è¨­å®šã«ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã€ã‚²ãƒ¼ãƒ ã«BGMã‚’è¿½åŠ ã—ã€è¨­å®šã«éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨ãƒŸãƒ¥ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã‚µã‚¤ãƒˆã®ã‚ºãƒ¼ãƒ ã¨ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸã€‚ã€Œå¼·åŠ›ãªã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’ã€Œãƒªãƒ“ãƒƒã‚°ãƒãƒ³ã€ã«æ”¹åã—ã¾ã—ãŸã€‚" },
            { version: "v1.3", date: "2024-06-20", notes: "è¨­å®šã«ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚" },
            { version: "v1.2", date: "2024-06-20", notes: "ã‚²ãƒ¼ãƒ ã«BGMã‚’è¿½åŠ ã—ã€è¨­å®šã«éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨ãƒŸãƒ¥ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚" },
            { version: "v1.1", date: "2024-06-19", notes: "æ–°ã—ã„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¨ç´°ã‹ã„èª¿æ•´" },
            { version: "v1.0", date: "2024-06-18", notes: "ã‚²ãƒ¼ãƒ ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸ" }
        ];

        // DOMè¦ç´ 
        const energyDisplay = document.getElementById('energy-display');
        const clickPowerDisplay = document.getElementById('click-power-display');
        const autoClickDisplay = document.getElementById('auto-click-display');
        const starClicker = document.getElementById('star-clicker');
        // åˆ†å‰²ã•ã‚ŒãŸã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
        const regularUpgradeList = document.getElementById('regular-upgrade-list');
        const oneTimeUpgradeList = document.getElementById('one-time-upgrade-list');
        const breakthroughUpgradeList = document.getElementById('breakthrough-upgrade-list'); // é™ç•Œçªç ´ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
        const breakthroughUpgradesSectionHeader = document.getElementById('breakthrough-upgrades-section'); // é™ç•Œçªç ´ãƒ˜ãƒƒãƒ€ãƒ¼
        const heatClickerDisplayWrapper = document.getElementById('heat-clicker-display-wrapper'); // ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚«ãƒ¼è¡¨ç¤ºã®ãƒ©ãƒƒãƒ‘ãƒ¼
        const heatMultiplierDisplay = document.getElementById('heat-multiplier-display');
        const excavationCooldownDisplayWrapper = document.getElementById('excavation-cooldown-display-wrapper');
        const excavationCooldownDisplay = document.getElementById('excavation-cooldown-display');
        const breakthroughMenuLink = document.getElementById('breakthrough-menu-link'); // é™ç•Œçªç ´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯

        const menuButton = document.getElementById('menu-button');
        const sidebar = document.getElementById('sidebar');
        const navLinks = document.querySelectorAll('#sidebar a');
        const sections = document.querySelectorAll('.section');

        // ãƒ¢ãƒ¼ãƒ€ãƒ« / ã‚µã‚¤ãƒ‰ãƒãƒ¼
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCancelButton = document.getElementById('modal-cancel');
        const modalConfirmButton = document.getElementById('modal-confirm');
        const settingsModal = document.getElementById('settings-modal');
        const deleteDataButton = document.getElementById('delete-data-button');
        const closeSettingsModalButton = document.getElementById('close-settings-modal');
        const modalCloseButtons = document.querySelectorAll('.modal-close-button'); // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ–°ã—ã„ãƒœã‚¿ãƒ³ã‚’å«ã‚€

        // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
        const upgradesSidebarModal = document.getElementById('upgrades-sidebar-modal');
        const closeUpgradesSidebarButton = document.getElementById('close-upgrades-sidebar');
        const batchCycleButton = document.getElementById('batch-cycle-button'); // æ–°ã—ã„å˜ä¸€ãƒãƒƒãƒè³¼å…¥ãƒœã‚¿ãƒ³

        // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
        const inventoryModal = document.getElementById('inventory-modal');
        const inventoryContent = document.getElementById('inventory-content');
        const closeInventoryModal = document.getElementById('close-inventory-modal');

        // æ¡æ˜ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
        const excavationMenuLink = document.getElementById('excavation-menu-link');
        const excavationModal = document.getElementById('excavation-modal');
        const excavationPlanetList = document.getElementById('excavation-planet-list');
        const closeExcavationModal = document.getElementById('close-excavation-modal');


        // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
        const releaseNotesButton = document.getElementById('release-notes-button');
        const releaseNotesModal = document.getElementById('release-notes-modal');
        const releaseNotesContent = document.getElementById('release-notes-content');
        const closeReleaseNotesModalButton = document.getElementById('close-release-notes-modal');

        // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
        const creditsButton = document.getElementById('credits-button');
        const creditsModal = document.getElementById('credits-modal');
        const creditsContent = document.getElementById('credits-content');
        const closeCreditsModalButton = document.getElementById('close-credits-modal');

        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´ 
        const audioElement = document.getElementById('background-music');
        const volumeSlider = document.getElementById('volume-slider');
        const speakerIcon = document.getElementById('speaker-icon');

        let currentConfirmCallback = null;
        let currentCancelCallback = null;
        let confirmationStep = 0; // å¤šæ®µéšå‰Šé™¤ç¢ºèªç”¨
        let lastVolumeBeforeMute = gameState.volume; // ãƒŸãƒ¥ãƒ¼ãƒˆå‰ã®éŸ³é‡ã‚’ä¿å­˜
        const batchAmounts = [1, 10, 50, 100, 'max']; // ãƒãƒƒãƒè³¼å…¥ã®é¸æŠè‚¢

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

        /**
         * å¤§ããªæ•°å€¤ã‚’å˜ä½ (K, M, B, T) ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¾ã™ã€‚
         * @param {number} num - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹æ•°å€¤ã€‚
         * @returns {string} ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸæ•°å€¤æ–‡å­—åˆ—ã€‚
         */
        function formatNumber(num) {
            if (num >= 1000000000000) {
                return (num / 1000000000000).toFixed(2) + 'T';
            }
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(2) + 'B';
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(2) + 'K';
            }
            return Math.floor(num).toLocaleString();
        }

        /**
         * æ®‹ã‚Šæ™‚é–“ã‚’HH:MM:SSå½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¾ã™ã€‚
         * @param {number} ms - æ®‹ã‚Šæ™‚é–“ (ãƒŸãƒªç§’)ã€‚
         * @returns {string} ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸæ™‚é–“æ–‡å­—åˆ—ã€‚
         */
        function formatTime(ms) {
            const totalSeconds = Math.max(0, Math.floor(ms / 1000));
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            return [hours, minutes, seconds]
                .map(unit => String(unit).padStart(2, '0'))
                .join(':');
        }

        /**
         * ã€Œå¼·åŠ›ãªæ–°è¦ã‚²ãƒ¼ãƒ ã€ã®ç¾åœ¨ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚³ã‚¹ãƒˆã‚’è¨ˆç®—ã—ã¾ã™ã€‚
         * ã‚³ã‚¹ãƒˆã¯å¼·åŠ›ãªã‚¹ã‚¿ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦æŒ‡æ•°é–¢æ•°çš„ã«å¢—åŠ ã—ã¾ã™ã€‚
         * @returns {number} æ¬¡ã®å¼·åŠ›ãªã‚¹ã‚¿ãƒ¼ãƒˆã«å¿…è¦ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚
         */
        function getStrongStartCurrentCost() {
            // æŒ‡æ•°é–¢æ•°çš„ãªå¢—åŠ ã‚’ã‚ˆã‚Šé¡•è‘—ã«ã™ã‚‹ãŸã‚ã« Math.pow(2, ...) ã‚’ä½¿ç”¨
            return BASE_STRONG_START_ENERGY_REQUIREMENT * Math.pow(2, gameState.strongStartLevel);
        }

        /**
         * ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚«ãƒ¼è¡¨ç¤ºã®HSLè‰²ã‚’ã€ç™½ã‹ã‚‰èµ¤ã¸è¨ˆç®—ã—ã¾ã™ã€‚
         * @param {number} multiplier - ç¾åœ¨ã®ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚¯å€ç‡ã€‚
         * @returns {string} HSLè‰²æ–‡å­—åˆ—ã€‚
         */
        function getHeatColor(multiplier) {
            const minMultiplier = 1.0;
            const maxMultiplier = gameState.upgrades.heatClicker.currentMaxMultiplier; // é™ç•Œçªç ´ã‚’è€ƒæ…®
            // å€ç‡ã‚’æœ€å°/æœ€å¤§ã«åŸºã¥ã„ã¦0-1ã®ç¯„å›²ã«æ­£è¦åŒ–
            const normalized = Math.max(0, Math.min(1, (multiplier - minMultiplier) / (maxMultiplier - minMultiplier)));

            // HSLå€¤ã‚’è£œé–“ã—ã¾ã™ã€‚
            // è‰²ç›¸ (H) ã¯èµ¤/ç™½/ã‚°ãƒ¬ãƒ¼ã®å ´åˆ0ã®ã¾ã¾ã€‚
            // å½©åº¦ (S) ã¯0%ï¼ˆç™½ï¼‰ã‹ã‚‰100%ï¼ˆèµ¤ï¼‰ã«å¤‰åŒ–ã€‚
            // æ˜åº¦ (L) ã¯100%ï¼ˆç™½ï¼‰ã‹ã‚‰50%ï¼ˆç´”ç²‹ãªèµ¤ï¼‰ã«æ¸›å°‘ã€‚
            const h = 0;
            const s = normalized * 100; // å½©åº¦ãŒ0ã‹ã‚‰100ã«å¢—åŠ 
            const l = 100 - (normalized * 50); // æ˜åº¦ãŒ100ã‹ã‚‰50ã«æ¸›å°‘

            return `hsl(${h}, ${s}%, ${l}%)`;
        }

        /**
         * éŸ³é‡ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°ã—ã¾ã™ã€‚
         * @param {number} volume - ç¾åœ¨ã®éŸ³é‡ (0-1)ã€‚
         * @param {boolean} isMuted - ç¾åœ¨ãƒŸãƒ¥ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã€‚
         */
        function updateSpeakerIcon(volume, isMuted) {
            let pathD;
            if (isMuted || volume === 0) {
                // éŸ³é‡ã‚ªãƒ•ã‚¢ã‚¤ã‚³ãƒ³
                pathD = "M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C19.56 15.34 20 13.73 20 12c0-3.28-2.11-6.04-5-6.81v2.06c2.22.82 3.79 3.02 3.79 5.09zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.27 4.27L16 21.73l1.73-1.73L21.73 21 23 19.73 4.27 3zM12 4L9.17 7H5v4h3.17l3.83 3.83V4z";
            } else if (volume > 0 && volume <= 0.5) {
                // éŸ³é‡å°ã‚¢ã‚¤ã‚³ãƒ³ (ä½éŸ³é‡)
                pathD = "M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z";
            } else {
                // éŸ³é‡å¤§ã‚¢ã‚¤ã‚³ãƒ³ (ä¸­/é«˜éŸ³é‡)
                pathD = "M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77zM3 9v6h4l5 5V4L7 9H3z";
            }
            speakerIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="${pathD}"/></svg>`;
        }

        // --- IndexedDBé–¢æ•° ---

        /**
         * IndexedDBãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
         * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆã—ã¾ã™ã€‚
         */
        function initDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('IndexedDBãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚');
                    resolve();
                };

                request.onerror = (event) => {
                    console.error('IndexedDBã‚¨ãƒ©ãƒ¼:', event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        /**
         * ç¾åœ¨ã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’IndexedDBã«ä¿å­˜ã—ã¾ã™ã€‚
         */
        async function saveGame() {
            if (!db) {
                console.error("IndexedDBãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¿å­˜ã§ãã¾ã›ã‚“ã€‚");
                return;
            }
            // ä¿å­˜å‰ã«lastPlayedTimeã‚’æ›´æ–°
            gameState.lastPlayedTime = Date.now();
            // ç¾åœ¨ã®éŸ³é‡ã‚’ä¿å­˜
            gameState.volume = audioElement.volume;
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.put(gameState, 'gameData'); // å›ºå®šã‚­ãƒ¼'gameData'ã‚’ä½¿ç”¨

            request.onsuccess = () => {
                // console.log('ã‚²ãƒ¼ãƒ ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
            };

            request.onerror = (event) => {
                console.error('ã‚²ãƒ¼ãƒ ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', event.target.errorCode);
            };
        }

        /**
         * IndexedDBã‹ã‚‰ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
         * ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€åˆæœŸã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’è¿”ã—ã¾ã™ã€‚
         */
        async function loadGame() {
            if (!db) {
                console.error("IndexedDBãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚");
                return;
            }
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get('gameData');

                request.onsuccess = (event) => {
                    let loadedState = event.target.result;
                    if (loadedState) {
                        // ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸçŠ¶æ…‹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ãƒãƒ¼ã‚¸ã—ã¦ã€æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™
                        // ã“ã‚Œã«ã‚ˆã‚Šã€æ–°ã—ã„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒgameStateã«è¿½åŠ ã•ã‚ŒãŸãŒã€
                        // å¤ã„ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã«ã¯å­˜åœ¨ã—ãªã„ã‚±ãƒ¼ã‚¹ãŒå‡¦ç†ã•ã‚Œã¾ã™ã€‚
                        gameState.energy = loadedState.energy || 0;
                        gameState.clickPower = loadedState.clickPower || 1;
                        gameState.autoClickPower = loadedState.autoClickPower || 0;
                        gameState.strongStartLevel = loadedState.strongStartLevel || 0;
                        gameState.lastPlayedTime = loadedState.lastPlayedTime || Date.now();
                        gameState.heatClickMultiplier = loadedState.heatClickMultiplier || 1.0;
                        gameState.lastClickTime = loadedState.lastClickTime || Date.now();
                        gameState.volume = loadedState.volume !== undefined ? loadedState.volume : 0.5; // éŸ³é‡ã‚’ãƒ­ãƒ¼ãƒ‰ã€å­˜åœ¨ã—ãªã„å ´åˆã¯0.5ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                        gameState.inventory = loadedState.inventory || {}; // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’ãƒ­ãƒ¼ãƒ‰ã€å­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                        gameState.planetExcavationCooldowns = loadedState.planetExcavationCooldowns || {}; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰
                        gameState.selectedBatchAmount = loadedState.selectedBatchAmount || 1; // ãƒãƒƒãƒè³¼å…¥é‡ã‚’ãƒ­ãƒ¼ãƒ‰

                        // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ãƒ­ãƒ¼ãƒ‰ã¨æ–°ã—ã„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®è¿½åŠ 
                        // æ–°ã—ã„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã« gameState.upgrades ãŒæ—¢å­˜ã®ã‚­ãƒ¼ã‚’ä¿æŒã—ã€
                        // å¤ã„ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã«ãªã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ (ä¾‹: type, targetUpgrade, maxLevel, icon, effect, unlocks) ã‚’
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§åŸ‹ã‚ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
                        for (const key in gameState.upgrades) {
                            if (loadedState.upgrades && loadedState.upgrades[key]) {
                                // æ—¢å­˜ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å ´åˆã€ä¿å­˜ã•ã‚ŒãŸãƒ¬ãƒ™ãƒ«ã¨ã‚³ã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
                                gameState.upgrades[key].level = loadedState.upgrades[key].level;
                                gameState.upgrades[key].cost = loadedState.upgrades[key].cost;
                                // ãã®ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ãƒãƒ¼ã‚¸ (ç‰¹ã«æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚„é™ç•Œçªç ´é–¢é€£)
                                Object.assign(gameState.upgrades[key], loadedState.upgrades[key]);
                            } else {
                                // æ–°ã—ã„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«åˆæœŸåŒ–
                                // initialCostãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ã‚³ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                                if (gameState.upgrades[key].initialCost) {
                                    gameState.upgrades[key].cost = gameState.upgrades[key].initialCost;
                                }
                                gameState.upgrades[key].level = 0;
                                if (gameState.upgrades[key].breakthroughLevel !== undefined) {
                                    gameState.upgrades[key].breakthroughLevel = 0;
                                }
                                // wideRangeTransferã®unlockedPlanetsã‚‚åˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«ã™ã‚‹
                                if (key === 'wideRangeTransfer') {
                                    gameState.upgrades[key].unlockedPlanets = [];
                                }
                            }
                        }

                        // wideRangeTransferã«ã‚ˆã£ã¦ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸæƒ‘æ˜Ÿã‚’gameState.upgradesã«è¿½åŠ 
                        // ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸunlockedPlanetsã«åŸºã¥ã„ã¦è¿½åŠ ã™ã‚‹
                        if (gameState.upgrades.wideRangeTransfer && gameState.upgrades.wideRangeTransfer.unlockedPlanets) {
                            gameState.upgrades.wideRangeTransfer.unlockedPlanets.forEach(newPlanetKey => {
                                if (!(newPlanetKey in gameState.upgrades) && newPlanetsData[newPlanetKey]) {
                                    gameState.upgrades[newPlanetKey] = { ...newPlanetsData[newPlanetKey] };
                                }
                            });
                        }


                        // ç†±ã‚¯ãƒªãƒƒã‚«ãƒ¼ã®æœ€å¤§å€ç‡ã‚’é™ç•Œçªç ´ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ã¦æ›´æ–°
                        updateHeatClickerMaxMultiplier();
                        // é™ç•Œçªç ´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºã‚’ãƒã‚§ãƒƒã‚¯
                        checkBreakthroughMenuVisibility();

                        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã®ç²å¾—ã‚’å‡¦ç†
                        if (gameState.lastPlayedTime) {
                            const currentTime = Date.now();
                            let timeAway = currentTime - gameState.lastPlayedTime;
                            timeAway = Math.min(timeAway, MAX_INACTIVITY_MS); // 24æ™‚é–“ã§ä¸Šé™è¨­å®š

                            const offlineEnergy = (gameState.autoClickPower / 1000) * timeAway; // autoClickPowerã¯1ç§’ã‚ãŸã‚Š
                            if (offlineEnergy > 0) {
                                gameState.energy += offlineEnergy;
                                showGenericModal(confirmationModal, `ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¸­ã« ${formatNumber(offlineEnergy)} ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ç²å¾—ã—ã¾ã—ãŸï¼`, null, () => hideModal(confirmationModal), 'OK', 'bg-green-600 hover:bg-green-700', 'é–‰ã˜ã‚‹');
                                modalConfirmButton.style.display = 'none'; // OKãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã€ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã®ã¿è¡¨ç¤º
                            }
                        }
                        console.log('ã‚²ãƒ¼ãƒ ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚');
                    } else {
                        console.log('ä¿å­˜ã•ã‚ŒãŸã‚²ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚');
                        // gameStateã¯ã™ã§ã«åˆæœŸçŠ¶æ…‹ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã•ã‚Œã¦ã„ã¾ã™
                        // æ–°ã—ã„ã‚²ãƒ¼ãƒ ã®å ´åˆã‚‚ç†±ã‚¯ãƒªãƒƒã‚«ãƒ¼ã®æœ€å¤§å€ç‡ã‚’åˆæœŸåŒ–
                        updateHeatClickerMaxMultiplier();
                    }
                    updateDisplay();
                    resolve();
                };

                request.onerror = (event) => {
                    console.error('ã‚²ãƒ¼ãƒ ã®ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', event.target.errorCode);
                    updateDisplay(); // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã§ã‚‚è¡¨ç¤ºã‚’æ›´æ–°
                    resolve(); // ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ãŸå ´åˆã§ã‚‚ç¶šè¡Œã™ã‚‹ãŸã‚ã«è§£æ±º
                };
            });
        }

        /**
         * IndexedDBã‹ã‚‰ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚
         */
        async function clearGameData() {
            if (!db) {
                console.error("IndexedDBãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã§ãã¾ã›ã‚“ã€‚");
                return;
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();

                request.onsuccess = () => {
                    console.log('IndexedDBã‹ã‚‰ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚');
                    resolve();
                };

                request.onerror = (event) => {
                    console.error('ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---

        /**
         * ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚«ãƒ¼ã®æœ€å¤§å€ç‡ã‚’é™ç•Œçªç ´ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ã¦æ›´æ–°ã—ã¾ã™ã€‚
         */
        function updateHeatClickerMaxMultiplier() {
            const heatClickerBTLvl = gameState.upgrades.heatClickerBreakthrough.level;
            // heatClickerã®currentMaxMultiplierãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°
            gameState.upgrades.heatClicker.currentMaxMultiplier = 2.0 + (heatClickerBTLvl * gameState.upgrades.heatClickerBreakthrough.effect);
            // ç¾åœ¨ã®heatClickMultiplierãŒæ–°ã—ã„æœ€å¤§å€¤ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
            gameState.heatClickMultiplier = Math.min(gameState.heatClickMultiplier, gameState.upgrades.heatClicker.currentMaxMultiplier);
        }

        /**
         * è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ãƒ‘ãƒ¯ãƒ¼ã«åŸºã¥ã„ã¦è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
         */
        function autoClickLoop() {
            gameState.energy += gameState.autoClickPower / 10; // 100msé–“éš”ãªã®ã§10ã§å‰²ã‚‹
            updateDisplay();
        }

        /**
         * éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ãŸã‚ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚«ãƒ¼ã®å€ç‡ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
         */
        function checkHeatClickerReset() {
            if (gameState.upgrades.heatClicker && gameState.upgrades.heatClicker.level > 0 &&
                gameState.heatClickMultiplier > 1.0 && // ã™ã§ã«ãƒ–ãƒ¼ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ãƒªã‚»ãƒƒãƒˆ
                Date.now() - gameState.lastClickTime >= HEAT_CLICKER_RESET_TIME_MS) {
                gameState.heatClickMultiplier = 1.0; // åŸºæœ¬å€ç‡ã«ãƒªã‚»ãƒƒãƒˆ
                updateDisplay(); // ãƒªã‚»ãƒƒãƒˆã‚’åæ˜ ã™ã‚‹ãŸã‚ã«è¡¨ç¤ºã‚’æ›´æ–°
            }
        }

        /**
         * ãƒ¡ã‚¤ãƒ³ã®æ¡æ˜ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
         */
        function updateExcavationCooldownDisplay() {
            // This display wrapper only makes sense if there's a global cooldown,
            // but now cooldowns are per-planet.
            // For simplicity, let's just make this visible if the license is owned.
            if (gameState.upgrades.excavationLicense && gameState.upgrades.excavationLicense.level > 0) {
                 excavationCooldownDisplayWrapper.style.display = 'block';
                 excavationCooldownDisplay.textContent = 'å„æƒ‘æ˜Ÿã‚’å‚ç…§'; // Changed text to reflect per-planet cooldown
                 excavationCooldownDisplay.style.color = '#cbd5e1'; // Neutral color
            } else {
                excavationCooldownDisplayWrapper.style.display = 'none';
            }
        }

        /**
         * å„æƒ‘æ˜Ÿã®æ¡æ˜ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã¨ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
         */
        function updateExcavationPlanetButtons() {
            if (!excavationModal.classList.contains('open')) return; // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ãªã„å ´åˆã¯æ›´æ–°ã—ãªã„

            // wideRangeTransferã§ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸæƒ‘æ˜Ÿã‚‚å«ã‚ã¦å…¨ã¦ã®æƒ‘æ˜Ÿã‚’ãƒ«ãƒ¼ãƒ—
            const allPlanetKeys = Object.keys(gameState.upgrades).filter(key =>
                gameState.upgrades[key].icon && gameState.upgrades[key].excavationCooldown
            );

            for (const planetKey of allPlanetKeys) {
                const planet = gameState.upgrades[planetKey];
                const button = document.querySelector(`#excavate-${planetKey}-button`);
                const cooldownBar = document.querySelector(`#cooldown-bar-${planetKey}`);
                const cooldownText = document.querySelector(`#cooldown-text-${planetKey}`);

                if (!button || !cooldownBar || !cooldownText) continue;

                const lastExcavated = gameState.planetExcavationCooldowns[planetKey] || 0;
                const planetCooldown = planet.excavationCooldown; // æƒ‘æ˜Ÿå›ºæœ‰ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å–å¾—
                const timeElapsed = Date.now() - lastExcavated;
                const remainingTime = planetCooldown - timeElapsed;

                if (planet.level < EXCAVATION_MIN_PLANET_LEVEL) {
                    button.disabled = true;
                    button.textContent = `ãƒ¬ãƒ™ãƒ« ${planet.level}/${EXCAVATION_MIN_PLANET_LEVEL} å¿…è¦`;
                    button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    button.classList.add('bg-gray-500');
                    cooldownBar.style.width = '0%';
                    cooldownText.textContent = '';
                } else if (remainingTime > 0) {
                    button.disabled = true;
                    button.textContent = `ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­`;
                    button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    button.classList.add('bg-gray-500');
                    const progress = (timeElapsed / planetCooldown) * 100;
                    cooldownBar.style.width = `${progress}%`;
                    cooldownText.textContent = `æ®‹ã‚Š: ${formatTime(remainingTime)}`;
                } else {
                    button.disabled = false;
                    button.textContent = `æ¡æ˜`;
                    button.classList.remove('bg-gray-500');
                    button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    cooldownBar.style.width = '100%';
                    cooldownText.textContent = 'æº–å‚™å®Œäº†';
                }
            }
        }


        /**
         * Updates the display elements with current game state.
         */
        function updateDisplay() {
            energyDisplay.textContent = formatNumber(gameState.energy);
            clickPowerDisplay.textContent = formatNumber(gameState.clickPower);
            autoClickDisplay.textContent = formatNumber(gameState.autoClickPower);
            
            // Update heat clicker display visibility and value
            if (gameState.upgrades.heatClicker && gameState.upgrades.heatClicker.level > 0) {
                heatClickerDisplayWrapper.style.display = 'block';
                heatMultiplierDisplay.textContent = `${gameState.heatClickMultiplier.toFixed(1)}x`;
                heatMultiplierDisplay.style.color = getHeatColor(gameState.heatClickMultiplier);
            } else {
                heatClickerDisplayWrapper.style.display = 'none';
            }

            // Update excavation menu link visibility
            if (gameState.upgrades.excavationLicense && gameState.upgrades.excavationLicense.level > 0) {
                excavationMenuLink.style.display = 'block';
            } else {
                excavationMenuLink.style.display = 'none';
            }

            updateExcavationCooldownDisplay();
            // updateExcavationPlanetButtons(); // This is called in a separate interval now for smoother animation
            saveGame(); // Save game state whenever display is updated (implies state change)
        }

        /**
         * Handles the star click event.
         */
        function clickStar() {
            // Ensure music starts playing on first interaction if not already playing
            if (audioElement.paused) {
                audioElement.play().catch(e => console.error("Autoplay failed:", e));
            }

            // Apply heat clicker bonus first if active
            if (gameState.upgrades.heatClicker && gameState.upgrades.heatClicker.level > 0) {
                const currentTime = Date.now();
                if (currentTime - gameState.lastClickTime < HEAT_CLICKER_RESET_TIME_MS) {
                    gameState.heatClickMultiplier = Math.min(gameState.upgrades.heatClicker.currentMaxMultiplier, gameState.heatClickMultiplier + HEAT_CLICKER_INCREMENT);
                } else {
                    // Reset and start with first increment
                    gameState.heatClickMultiplier = Math.min(gameState.upgrades.heatClicker.currentMaxMultiplier, 1.0 + HEAT_CLICKER_INCREMENT);
                }
                gameState.lastClickTime = currentTime;
                // Add base click power, then the bonus from multiplier
                gameState.energy += gameState.clickPower * gameState.heatClickMultiplier;
            } else {
                gameState.energy += gameState.clickPower; // Normal click power
                gameState.heatClickMultiplier = 1.0; // Ensure reset if not active
            }
            updateDisplay();
        }

        /**
         * Calculates the cost and effects for purchasing a batch of upgrades.
         * @param {string} upgradeKey - The key of the upgrade to calculate for.
         * @param {number | 'max'} amount - The number of levels to simulate purchase for, or 'max'.
         * @returns {{totalEnergyCost: number, totalItemCost: object, levelsBought: number, totalClickBonus: number, totalAutoBonus: number, breakthroughLevelsBought: number}}
         */
        function calculateBatchCostAndEffects(upgradeKey, amount) {
            const upgrade = gameState.upgrades[upgradeKey];
            let simulatedCost = upgrade.cost;
            let simulatedLevel = upgrade.level;
            let totalEnergyCost = 0;
            let totalItemCost = {}; // ã‚¢ã‚¤ãƒ†ãƒ ã‚³ã‚¹ãƒˆã‚’è¿½è·¡
            let levelsBought = 0;
            let totalClickBonus = 0;
            let totalAutoBonus = 0;
            let breakthroughLevelsBought = 0;

            // é™ç•Œçªç ´ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å ´åˆã®ç‰¹æ®Šå‡¦ç†
            if (upgrade.type === 'breakthrough') { // 'type'ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§åˆ¤å®š
                if (upgrade.level >= upgrade.maxLevel) {
                    return { totalEnergyCost: 0, totalItemCost: {}, levelsBought: 0, totalClickBonus: 0, totalAutoBonus: 0, breakthroughLevelsBought: 0 };
                }
                // é™ç•Œçªç ´ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯1ãƒ¬ãƒ™ãƒ«ãšã¤ã—ã‹è³¼å…¥ã§ããªã„ã¨ä»®å®š
                amount = 1; // å¸¸ã«1ãƒ¬ãƒ™ãƒ«è³¼å…¥ (maxé¸æŠæ™‚ã‚‚)

                // ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚³ã‚¹ãƒˆã®ç¢ºèª
                if (gameState.energy < simulatedCost) {
                    return { totalEnergyCost: 0, totalItemCost: {}, levelsBought: 0, totalClickBonus: 0, totalAutoBonus: 0, breakthroughLevelsBought: 0 };
                }

                // ã‚¢ã‚¤ãƒ†ãƒ ã‚³ã‚¹ãƒˆã®ç¢ºèª
                let canAffordItems = true;
                if (upgrade.itemCost) {
                    for (const itemKey in upgrade.itemCost) {
                        if ((gameState.inventory[itemKey] || 0) < upgrade.itemCost[itemKey]) {
                            canAffordItems = false;
                            break;
                        }
                    }
                }
                if (!canAffordItems) {
                    return { totalEnergyCost: 0, totalItemCost: {}, levelsBought: 0, totalClickBonus: 0, totalAutoBonus: 0, breakthroughLevelsBought: 0 };
                }

                totalEnergyCost += simulatedCost;
                if (upgrade.itemCost) {
                    for (const itemKey in upgrade.itemCost) {
                        totalItemCost[itemKey] = (totalItemCost[itemKey] || 0) + upgrade.itemCost[itemKey];
                    }
                }
                breakthroughLevelsBought = 1;
                levelsBought = 1; // é™ç•Œçªç ´ã‚‚ä¸€ç¨®ã®ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ

                return { totalEnergyCost, totalItemCost, levelsBought, totalClickBonus, totalAutoBonus, breakthroughLevelsBought };
            }

            // é€šå¸¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å ´åˆ
            if (upgrade.maxLevel === 1 && upgrade.level >= 1) {
                return { totalEnergyCost: 0, totalItemCost: {}, levelsBought: 0, totalClickBonus: 0, totalAutoBonus: 0, breakthroughLevelsBought: 0 }; // Already purchased one-time upgrade
            }

            let limit = amount;
            if (amount === 'max') {
                limit = Infinity; // Try to buy as many as possible
            }

            for (let i = 0; i < limit; i++) {
                if (upgrade.maxLevel === 1 && simulatedLevel >= 1) break;

                // æœ€å¤§å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®ãƒ¬ãƒ™ãƒ«ã‚’è¶…ãˆã¦è³¼å…¥ã—ã‚ˆã†ã¨ã—ãªã„
                if (upgrade.maxLevel && simulatedLevel >= upgrade.maxLevel) {
                    break;
                }

                if (gameState.energy >= (totalEnergyCost + simulatedCost)) {
                    totalEnergyCost += simulatedCost;
                    totalClickBonus += upgrade.clickBonus;
                    totalAutoBonus += upgrade.autoBonus;
                    levelsBought++;
                    simulatedLevel++;
                    if (upgrade.maxLevel !== 1) { // Only increase cost if not a one-time upgrade
                        simulatedCost = Math.floor(simulatedCost * 1.5); // Calculate next level's cost
                    }
                } else {
                    break; // Cannot afford next level
                }
            }
            return { totalEnergyCost, totalItemCost, levelsBought, totalClickBonus, totalAutoBonus, breakthroughLevelsBought };
        }


        /**
         * Handles the purchase of an upgrade (single or batch).
         * @param {string} upgradeKey - The key of the upgrade to purchase.
         * @param {number | 'max'} amount - The number of levels to buy, or 'max'.
         */
        function buyUpgradeLogic(upgradeKey, amount) {
            const upgrade = gameState.upgrades[upgradeKey];

            // For one-time upgrades, if already purchased, do nothing.
            if (upgrade.maxLevel === 1 && upgrade.level >= 1 && upgrade.type !== 'breakthrough') {
                console.log("This upgrade can only be purchased once.");
                return;
            }

            const { totalEnergyCost, totalItemCost, levelsBought, totalClickBonus, totalAutoBonus, breakthroughLevelsBought } = calculateBatchCostAndEffects(upgradeKey, amount);

            if (levelsBought > 0) {
                // ã‚¨ãƒãƒ«ã‚®ãƒ¼æ¶ˆè²»
                gameState.energy -= totalEnergyCost;

                // ã‚¢ã‚¤ãƒ†ãƒ æ¶ˆè²»
                for (const itemKey in totalItemCost) {
                    gameState.inventory[itemKey] -= totalItemCost[itemKey];
                }

                gameState.clickPower += totalClickBonus;
                gameState.autoClickPower += totalAutoBonus;
                upgrade.level += levelsBought;

                // é™ç•Œçªç ´ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å ´åˆã®ç‰¹æ®ŠãªåŠ¹æœ
                if (upgrade.type === 'breakthrough' && upgrade.targetUpgrade) {
                    const targetUpgrade = gameState.upgrades[upgrade.targetUpgrade];
                    if (targetUpgrade) {
                        targetUpgrade.breakthroughLevel = (targetUpgrade.breakthroughLevel || 0) + breakthroughLevelsBought;
                        // ç†±ã‚¯ãƒªãƒƒã‚«ãƒ¼ã®æœ€å¤§å€ç‡ã‚’æ›´æ–°
                        if (upgrade.targetUpgrade === 'heatClicker') {
                            updateHeatClickerMaxMultiplier();
                        }
                        // åºƒç¯„å›²è»¢é€è£…ç½®ã§æ–°ã—ã„æƒ‘æ˜Ÿã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
                        if (upgrade.targetUpgrade === 'wideRangeTransfer' && upgrade.unlocks) {
                            upgrade.unlocks.slice(0, targetUpgrade.breakthroughLevel).forEach(newPlanetKey => {
                                if (!(newPlanetKey in gameState.upgrades) && newPlanetsData[newPlanetKey]) { // é‡è¤‡è¿½åŠ ã‚’é˜²ã
                                    gameState.upgrades[newPlanetKey] = { ...newPlanetsData[newPlanetKey] };
                                    // wideRangeTransferã®unlockedPlanetsã«æ–°ã—ã„æƒ‘æ˜Ÿã‚’è¿½åŠ 
                                    if (!targetUpgrade.unlockedPlanets.includes(newPlanetKey)) {
                                        targetUpgrade.unlockedPlanets.push(newPlanetKey);
                                    }
                                }
                            });
                        }
                    }
                }


                if (upgrade.maxLevel !== 1 && upgrade.type !== 'breakthrough') { // é€šå¸¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ã¿ã‚³ã‚¹ãƒˆã‚’å¢—åŠ ã•ã›ã‚‹
                    // Recalculate the cost for the *next* level after the batch purchase
                    upgrade.cost = Math.floor(upgrade.cost * Math.pow(1.5, levelsBought));
                }

                updateDisplay();
                renderUpgrades(); // Re-render upgrades after purchase to update button states
                renderInventory(); // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’æ›´æ–°
                renderExcavationPlanets(); // æ–°ã—ã„æƒ‘æ˜ŸãŒã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚æ›´æ–°
                // If excavationLicense is purchased, update the menu link visibility
                if (upgradeKey === 'excavationLicense') {
                    excavationMenuLink.style.display = 'block';
                }
                checkBreakthroughMenuVisibility(); // é™ç•Œçªç ´ãŒè³¼å…¥ã•ã‚ŒãŸã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
            } else {
                console.log("Not enough resources to buy any levels of " + upgradeKey);
            }
        }


        /**
         * Renders the upgrade items in the upgrades section.
         */
        function renderUpgrades() {
            // Store current scroll position before clearing
            const upgradesSidebarContent = upgradesSidebarModal.querySelector('.upgrades-sidebar-content');
            const upgradesScrollTop = upgradesSidebarContent ? upgradesSidebarContent.scrollTop : 0; // Check if element exists

            regularUpgradeList.innerHTML = ''; // Clear previous regular upgrades
            oneTimeUpgradeList.innerHTML = ''; // Clear previous one-time upgrades
            breakthroughUpgradeList.innerHTML = ''; // Clear previous breakthrough upgrades

            const upgradeKeys = Object.keys(gameState.upgrades);

            // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚½ãƒ¼ãƒˆ
            const regularUpgradeKeys = [];
            const oneTimeUpgradeKeys = [];
            const breakthroughUpgradeKeys = [];
            for (const key of upgradeKeys) {
                const upgrade = gameState.upgrades[key];
                if (upgrade.type === 'breakthrough') { // é™ç•Œçªç ´ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                    breakthroughUpgradeKeys.push(key);
                } else if (upgrade.maxLevel === 1) { // ä¸€å›é™ã‚Šã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                    oneTimeUpgradeKeys.push(key);
                } else if (!upgrade.itemCost) { // ã‚¢ã‚¤ãƒ†ãƒ ã‚³ã‚¹ãƒˆãŒãªã„é€šå¸¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                    regularUpgradeKeys.push(key);
                }
            }

            // å„ã‚«ãƒ†ã‚´ãƒªã‚’ã‚³ã‚¹ãƒˆã§ã‚½ãƒ¼ãƒˆ
            regularUpgradeKeys.sort((a, b) => gameState.upgrades[a].cost - gameState.upgrades[b].cost);
            oneTimeUpgradeKeys.sort((a, b) => gameState.upgrades[a].cost - gameState.upgrades[b].cost);
            breakthroughUpgradeKeys.sort((a, b) => gameState.upgrades[a].cost - gameState.upgrades[b].cost);


            regularUpgradeKeys.forEach(key => {
                const upgrade = gameState.upgrades[key];
                const upgradeElement = createUpgradeElement(key, upgrade);
                regularUpgradeList.appendChild(upgradeElement);
            });

            oneTimeUpgradeKeys.forEach(key => {
                const upgrade = gameState.upgrades[key];
                // Heat Clickerã¯è³¼å…¥æ¸ˆã¿ãªã‚‰è¡¨ç¤ºã—ãªã„ (ã“ã‚Œã¯é€šå¸¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚)
                // wideRangeTransferã‚‚åŒæ§˜ã«ã€ã“ã“ã§ã¯è¡¨ç¤ºã—ãªã„
                if (key === 'heatClicker' && upgrade.level > 0) {
                    return;
                }
                if (key === 'wideRangeTransfer' && upgrade.level > 0) {
                    return;
                }
                const upgradeElement = createUpgradeElement(key, upgrade);
                oneTimeUpgradeList.appendChild(upgradeElement);
            });

            // é™ç•Œçªç ´ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            if (breakthroughUpgradeKeys.length > 0) {
                breakthroughUpgradesSectionHeader.style.display = 'block'; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¡¨ç¤º
                breakthroughUpgradeKeys.forEach(key => {
                    const upgrade = gameState.upgrades[key];
                    const upgradeElement = createUpgradeElement(key, upgrade);
                    breakthroughUpgradeList.appendChild(upgradeElement);
                });
            } else {
                breakthroughUpgradesSectionHeader.style.display = 'none'; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤º
            }


            // Restore scroll position after rendering
            // Added a small delay to ensure DOM is rendered before attempting to scroll
            if (upgradesSidebarContent) {
                setTimeout(() => {
                    upgradesSidebarContent.scrollTop = upgradesScrollTop;
                }, 50); // Small delay
            }
        }

        // Helper function to create an individual upgrade element
        function createUpgradeElement(key, upgrade) {
            const upgradeElement = document.createElement('div');
            upgradeElement.className = 'upgrade-item';

            let upgradeStatusText = '';
            let isPurchasedOneTime = (upgrade.maxLevel === 1 && upgrade.level >= 1 && upgrade.type !== 'breakthrough'); // é™ç•Œçªç ´ã¯åˆ¥é€”åˆ¤å®š
            let purchaseButtonText = 'è³¼å…¥';

            if (isPurchasedOneTime) {
                upgradeStatusText = `<p class="text-sm text-green-400 font-bold">è³¼å…¥æ¸ˆã¿</p>`;
                purchaseButtonText = 'å®Œäº†';
            } else if (upgrade.type === 'breakthrough' && upgrade.level >= upgrade.maxLevel) { // é™ç•Œçªç ´ã®æœ€å¤§ãƒ¬ãƒ™ãƒ«é”æˆ
                upgradeStatusText = `<p class="text-sm text-green-400 font-bold">æœ€å¤§ãƒ¬ãƒ™ãƒ«</p>`;
                purchaseButtonText = 'å®Œäº†';
            }
            else {
                const { totalEnergyCost, totalItemCost, levelsBought } = calculateBatchCostAndEffects(key, gameState.selectedBatchAmount);

                if (levelsBought === 0) {
                     purchaseButtonText = 'ä¸è¶³';
                } else if (gameState.selectedBatchAmount === 'max') {
                    purchaseButtonText = `è³¼å…¥ (Max)`;
                }
                else {
                    purchaseButtonText = `è³¼å…¥ (x${levelsBought})`;
                }


                let costDetails = `<p class="text-lg font-bold mb-2">ã‚¨ãƒãƒ«ã‚®ãƒ¼: ${formatNumber(upgrade.cost)}</p>`;
                if (upgrade.itemCost) {
                    for (const itemKey in upgrade.itemCost) {
                        const item = itemData[itemKey] || { name: itemKey, icon: 'â“' };
                        costDetails += `<p class="text-sm text-gray-400">${item.icon} ${item.name}: ${formatNumber(upgrade.itemCost[itemKey])}</p>`;
                    }
                }
                upgradeStatusText = costDetails;
            }

            // é™ç•Œçªç ´ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å ´åˆã€ç¾åœ¨ã®é™ç•Œçªç ´ãƒ¬ãƒ™ãƒ«ã‚’è¡¨ç¤º
            let breakthroughInfo = '';
            if (upgrade.breakthroughLevel !== undefined) {
                breakthroughInfo = `<p class="text-sm text-purple-400">é™ç•Œçªç ´: ${upgrade.breakthroughLevel}/${upgrade.maxLevel}</p>`;
                if (upgrade.targetUpgrade === 'heatClicker') {
                    breakthroughInfo += `<p class="text-sm text-purple-400">æœ€å¤§å€ç‡: ${gameState.upgrades.heatClicker.currentMaxMultiplier.toFixed(1)}x</p>`; // å‹•çš„ã«æ›´æ–°ã•ã‚ŒãŸå€¤ã‚’ä½¿ç”¨
                }
            }


            upgradeElement.innerHTML = `
                <div class="flex items-center upgrade-info">
                    <span class="upgrade-icon">${upgrade.icon}</span>
                    <div>
                        <h3 class="text-xl font-semibold">${key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1').trim()}</h3>
                        <p class="text-sm text-gray-400">ãƒ¬ãƒ™ãƒ«: ${upgrade.level}</p>
                        ${breakthroughInfo}
                        ${upgrade.clickBonus > 0 ? `<p class="text-sm text-gray-400">ã‚¯ãƒªãƒƒã‚¯ãƒ‘ãƒ¯ãƒ¼ +${formatNumber(upgrade.clickBonus)}</p>` : ''}
                        ${upgrade.autoBonus > 0 ? `<p class="text-sm text-gray-400">è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ +${formatNumber(upgrade.autoBonus)}/ç§’</p>` : ''}
                    </div>
                </div>
                <div class="upgrade-actions">
                    ${upgradeStatusText}
                    <button data-upgrade="${key}" class="buy-upgrade px-5 py-2 rounded-lg font-semibold transition duration-200">
                        ${purchaseButtonText}
                    </button>
                </div>
            `;
            const buyButton = upgradeElement.querySelector('.buy-upgrade');

            const { totalEnergyCost, totalItemCost, levelsBought } = calculateBatchCostAndEffects(key, gameState.selectedBatchAmount);

            let canAfford = true;
            if (totalEnergyCost > gameState.energy) canAfford = false;
            for (const itemKey in totalItemCost) {
                if ((gameState.inventory[itemKey] || 0) < totalItemCost[itemKey]) {
                    canAfford = false;
                    break;
                }
            }

            // é™ç•Œçªç ´ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯ã€æœ€å¤§ãƒ¬ãƒ™ãƒ«ã«é”ã—ã¦ã„ãŸã‚‰è³¼å…¥ä¸å¯
            if (upgrade.type === 'breakthrough' && upgrade.level >= upgrade.maxLevel) {
                canAfford = false;
            } else if (isPurchasedOneTime) { // ä¸€å›é™ã‚Šã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                canAfford = false;
            }


            if (!canAfford || levelsBought === 0) {
                buyButton.disabled = true;
                buyButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                buyButton.classList.add('bg-gray-500'); // Apply disabled style
            } else {
                buyButton.disabled = false;
                buyButton.classList.remove('bg-gray-500'); // Ensure disabled style is removed
                buyButton.classList.add('bg-blue-600', 'hover:bg-blue-700'); // Apply active styles
            }
            buyButton.addEventListener('click', () => buyUpgradeLogic(key, gameState.selectedBatchAmount));
            return upgradeElement;
        }


        /**
         * ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªå†…ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
         */
        function renderInventory() {
            inventoryContent.innerHTML = ''; // ä»¥å‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªã‚¢
            const hasItems = Object.keys(gameState.inventory).some(key => gameState.inventory[key] > 0);

            if (!hasItems) {
                inventoryContent.innerHTML = '<p class="text-center text-gray-400">ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã¯ç©ºã§ã™ã€‚</p>';
                return;
            }

            for (const itemKey in itemData) { // å®šç¾©ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã®ã¿è¡¨ç¤º
                if (gameState.inventory[itemKey] && gameState.inventory[itemKey] > 0) {
                    const item = itemData[itemKey];
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item flex justify-between items-center';
                    itemElement.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">${item.icon}</span>
                            <p class="text-lg font-semibold">${item.name}</p>
                        </div>
                        <p class="text-xl font-bold">${formatNumber(gameState.inventory[itemKey])}</p>
                    `;
                    inventoryContent.appendChild(itemElement);
                }
            }
        }

        /**
         * æ¡æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æƒ‘æ˜Ÿã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
         */
        function renderExcavationPlanets() {
            excavationPlanetList.innerHTML = ''; // ä»¥å‰ã®æƒ‘æ˜Ÿã‚’ã‚¯ãƒªã‚¢

            // gameState.upgradeså†…ã®é€šå¸¸ã®æƒ‘æ˜Ÿã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¨wideRangeTransferã§ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸæƒ‘æ˜Ÿã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
            const allPlanetKeys = Object.keys(gameState.upgrades).filter(key =>
                gameState.upgrades[key].icon && gameState.upgrades[key].excavationCooldown
            );

            // ã‚³ã‚¹ãƒˆã§ã‚½ãƒ¼ãƒˆï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã®é †åºã¨åŒã˜ã«ãªã‚‹ãŸã‚ï¼‰
            allPlanetKeys.sort((a, b) => gameState.upgrades[a].cost - gameState.upgrades[b].cost);


            if (allPlanetKeys.length === 0) {
                excavationPlanetList.innerHTML = '<p class="text-center text-gray-400">æ¡æ˜å¯èƒ½ãªæƒ‘æ˜Ÿã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            allPlanetKeys.forEach(key => {
                const planet = gameState.upgrades[key];
                const planetName = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1').trim(); // ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ã‚’ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã«å¤‰æ›
                const excavationElement = document.createElement('div');
                excavationElement.className = 'excavation-planet-item flex flex-col justify-between items-start';

                const lastExcavated = gameState.planetExcavationCooldowns[key] || 0;
                const planetCooldown = planet.excavationCooldown; // æƒ‘æ˜Ÿå›ºæœ‰ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å–å¾—
                const timeElapsed = Date.now() - lastExcavated;
                const remainingTime = planetCooldown - timeElapsed;
                const isReady = remainingTime <= 0;
                const canExcavate = planet.level >= EXCAVATION_MIN_PLANET_LEVEL && isReady;

                excavationElement.innerHTML = `
                    <div class="flex items-center w-full">
                        <span class="text-3xl mr-3">${planet.icon}</span>
                        <h3 class="text-xl font-semibold flex-grow">${planetName} (Lv ${planet.level})</h3>
                        <button data-planet="${key}" class="excavate-button px-4 py-2 rounded-lg font-semibold transition duration-200
                            ${canExcavate ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-500 cursor-not-allowed'}"
                            ${!canExcavate ? 'disabled' : ''}>
                            ${planet.level < EXCAVATION_MIN_PLANET_LEVEL ? `ãƒ¬ãƒ™ãƒ« ${planet.level}/${EXCAVATION_MIN_PLANET_LEVEL} å¿…è¦` : (isReady ? 'æ¡æ˜' : 'ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­')}
                        </button>
                    </div>
                    <div class="w-full mt-2">
                        <div class="cooldown-bar-wrapper">
                            <div id="cooldown-bar-${key}" class="cooldown-bar" style="width: ${isReady ? 100 : (timeElapsed / planetCooldown) * 100}%;"></div>
                        </div>
                        <p id="cooldown-text-${key}" class="excavation-cooldown-display text-xs text-right mt-1">
                            ${isReady ? 'æº–å‚™å®Œäº†' : `æ®‹ã‚Š: ${formatTime(remainingTime)}`}
                        </p>
                    </div>
                `;
                excavationPlanetList.appendChild(excavationElement);
            });

            // æ–°ã—ã„ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ
            excavationPlanetList.querySelectorAll('.excavate-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const planetKey = event.target.dataset.planet;
                    excavatePlanet(planetKey);
                });
            });
            updateExcavationPlanetButtons(); // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³è¡¨ç¤ºã®ãŸã‚ã«åˆæœŸæ›´æ–°
        }

        /**
         * æƒ‘æ˜Ÿã‚’æ¡æ˜ã—ã¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—ã—ã¾ã™ã€‚
         * @param {string} planetKey - æ¡æ˜ã™ã‚‹æƒ‘æ˜Ÿã®ã‚­ãƒ¼ã€‚
         */
        function excavatePlanet(planetKey) {
            const planet = gameState.upgrades[planetKey];
            if (planet.level < EXCAVATION_MIN_PLANET_LEVEL) {
                showGenericModal(confirmationModal, `${planetKey}ã‚’æ¡æ˜ã™ã‚‹ã«ã¯ãƒ¬ãƒ™ãƒ«${EXCAVATION_MIN_PLANET_LEVEL}ãŒå¿…è¦ã§ã™ã€‚`, null, () => hideModal(confirmationModal), 'OK', 'bg-blue-600 hover:bg-blue-700', 'é–‰ã˜ã‚‹');
                modalConfirmButton.style.display = 'none';
                return;
            }

            const lastExcavated = gameState.planetExcavationCooldowns[planetKey] || 0;
            const planetCooldown = planet.excavationCooldown; // æƒ‘æ˜Ÿå›ºæœ‰ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å–å¾—
            const timeElapsed = Date.now() - lastExcavated;
            if (timeElapsed < planetCooldown) {
                const remainingTime = planetCooldown - timeElapsed;
                showGenericModal(confirmationModal, `${planetKey}ã¯ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã§ã™ã€‚æ®‹ã‚Š: ${formatTime(remainingTime)}`, null, () => hideModal(confirmationModal), 'OK', 'bg-blue-600 hover:bg-blue-700', 'é–‰ã˜ã‚‹');
                modalConfirmButton.style.display = 'none';
                return;
            }

            // æ¡æ˜ãƒ­ã‚¸ãƒƒã‚¯ï¼šæƒ‘æ˜Ÿãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å–å¾—
            const itemsFound = {};
            let totalItems = 0;
            let message = `${planet.icon} ${planetKey.charAt(0).toUpperCase() + planetKey.slice(1).replace(/([A-Z])/g, ' $1').trim()}ã‚’æ¡æ˜ã—ã¾ã—ãŸï¼`; // æƒ‘æ˜Ÿåã‚‚æ•´å½¢

            // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ç²å¾—ã‚¢ã‚¤ãƒ†ãƒ ã®æ•°ã‚’å¢—ã‚„ã™
            // baseItemsã¯æœ€ä½1ã¤ã€ãã®å¾Œ10ãƒ¬ãƒ™ãƒ«ã”ã¨ã«1ã¤è¿½åŠ 
            const baseItems = 1 + Math.floor(planet.level / 10);
            for (let i = 0; i < baseItems; i++) {
                const random = Math.random();
                let acquiredItem = '';
                if (random < 0.5) { // 50% é‰„é‰±çŸ³
                    acquiredItem = 'ironOre';
                } else if (random < 0.8) { // 30% éŠ…é‰±çŸ³
                    acquiredItem = 'copperOre';
                } else if (random < 0.95) { // 15% éŠ€é‰±çŸ³
                    acquiredItem = 'silverOre';
                } else { // 5% é‡‘é‰±çŸ³
                    acquiredItem = 'goldOre';
                }

                gameState.inventory[acquiredItem] = (gameState.inventory[acquiredItem] || 0) + 1;
                itemsFound[acquiredItem] = (itemsFound[acquiredItem] || 0) + 1;
                totalItems++;
            }

            if (totalItems > 0) {
                message += '<br>ç²å¾—ã‚¢ã‚¤ãƒ†ãƒ :';
                for (const itemKey in itemsFound) {
                    message += `<br>${itemData[itemKey].icon} ${itemData[itemKey].name}: ${itemsFound[itemKey]}`;
                }
            } else {
                message += '<br>ä½•ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
            }


            gameState.planetExcavationCooldowns[planetKey] = Date.now(); // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’è¨­å®š
            updateDisplay(); // ãƒ¡ã‚¤ãƒ³ã®ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã¨ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒãƒ¼ã‚’æ›´æ–°
            renderExcavationPlanets(); // æ¡æ˜ç”»é¢ã®ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            renderInventory(); // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’æ›´æ–°

            showGenericModal(confirmationModal, message, null, () => hideModal(confirmationModal), 'OK', 'bg-green-600 hover:bg-green-700', 'é–‰ã˜ã‚‹');
            modalConfirmButton.style.display = 'none';
        }


        /**
         * ã‚²ãƒ¼ãƒ ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚
         * @param {boolean} strongStart - trueã®å ´åˆã€å¼·åŠ›ãªã‚¹ã‚¿ãƒ¼ãƒˆãƒœãƒ¼ãƒŠã‚¹ã‚’é©ç”¨ã—ã¾ã™ã€‚
         */
        async function resetGame(strongStart = false) {
            // strongStartãŒtrueã®å ´åˆã€ã‚¯ãƒªã‚¢ã™ã‚‹å‰ã«ç¾åœ¨ã®strongStartLevelã‚’ä¿å­˜
            const prevStrongStartLevel = gameState.strongStartLevel;

            await clearGameData(); // ã¾ãšIndexedDBã‚’ã‚¯ãƒªã‚¢

            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€å¼·åŠ›ãªã‚¹ã‚¿ãƒ¼ãƒˆã®å ´åˆã¯strongStartLevelã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
            let newStrongStartLevel = strongStart ? prevStrongStartLevel + 1 : 0;

            // åˆæœŸã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã—ã¦ã€ã‚³ã‚¹ãƒˆã‚’ç‰¹ã«ã‚¯ãƒªãƒ¼ãƒ³ãªãƒªã‚»ãƒƒãƒˆã‚’ä¿è¨¼ã™ã‚‹
            // ã“ã“ã§newPlanetsDataã‚‚è€ƒæ…®ã«å…¥ã‚Œã¦ã€åˆæœŸçŠ¶æ…‹ã«ã¯å«ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹
            let initialUpgrades = JSON.parse(JSON.stringify({
                mercury: { level: 0, cost: 10, clickBonus: 1, autoBonus: 0, icon: 'â˜¿', excavationCooldown: 10 * 1000 },
                venus: { level: 0, cost: 50, clickBonus: 3, autoBonus: 0, icon: 'â™€', excavationCooldown: 15 * 1000 },
                earth: { level: 0, cost: 200, clickBonus: 0, autoBonus: 5, icon: 'ğŸŒ', excavationCooldown: 20 * 1000 },
                mars: { level: 0, cost: 1000, clickBonus: 10, autoBonus: 0, icon: 'â™‚', excavationCooldown: 30 * 1000 },
                jupiter: { level: 0, cost: 5000, clickBonus: 0, autoBonus: 50, icon: 'â™ƒ', excavationCooldown: 45 * 1000 },
                saturn: { level: 0, cost: 25000, clickBonus: 0, autoBonus: 200, icon: 'â™„', excavationCooldown: 60 * 1000 },
                uranus: { level: 0, cost: 100000, clickBonus: 50, autoBonus: 0, icon: 'â›¢', excavationCooldown: 90 * 1000 },
                neptune: { level: 0, cost: 500000, clickBonus: 0, autoBonus: 1000, icon: 'â™†', excavationCooldown: 120 * 1000 },
                originalPlanetX: { level: 0, cost: 2000000, clickBonus: 500, autoBonus: 5000, icon: 'ğŸª', excavationCooldown: 180 * 1000 },
                cosmicDrill: { level: 0, initialCost: 1e7, cost: 1e7, clickBonus: 10000, autoBonus: 0, icon: 'â›ï¸', maxLevel: 1 },
                galacticReactor: { level: 0, initialCost: 5e7, cost: 5e7, clickBonus: 0, autoBonus: 10000, icon: 'âš›ï¸', maxLevel: 1 },
                heatClicker: { level: 0, initialCost: 1e6, cost: 1e6, clickBonus: 0, autoBonus: 0, icon: 'ğŸ”¥', maxLevel: 1, currentMaxMultiplier: 2.0 },
                excavationLicense: { level: 0, initialCost: 1e5, cost: 1e5, clickBonus: 0, autoBonus: 0, icon: 'ğŸ“œ', maxLevel: 1 },
                wideRangeTransfer: { level: 0, initialCost: 1e8, cost: 1e8, clickBonus: 0, autoBonus: 0, icon: 'ğŸ“¡', maxLevel: 1, unlockedPlanets: [], breakthroughLevel: 0 },
                heatClickerBreakthrough: { level: 0, initialCost: 1e6, cost: 1e6, itemCost: { ironOre: 100, silverOre: 10 }, targetUpgrade: 'heatClicker', maxLevel: 5, icon: 'ğŸ’¥', effect: 0.2, type: 'breakthrough' },
                wideRangeTransferBreakthrough: { level: 0, initialCost: 5e6, cost: 5e6, itemCost: { goldOre: 5, copperOre: 500 }, targetUpgrade: 'wideRangeTransfer', maxLevel: 3, icon: 'âš¡', unlocks: [ 'cometA', 'dwarfPlanet', 'gasGiantMoon' ], type: 'breakthrough' }
            }));

            // æ–°ã—ã„æƒ‘æ˜Ÿã¯åˆæœŸçŠ¶æ…‹ã§ã¯å«ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹
            // initialUpgradesã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰newPlanetsDataã®ã‚­ãƒ¼ã‚’å‰Šé™¤
            for (const key in newPlanetsData) {
                delete initialUpgrades[key];
            }


            gameState = {
                energy: 0,
                clickPower: 1,
                autoClickPower: 0,
                strongStartLevel: newStrongStartLevel,
                lastPlayedTime: Date.now(), // æ–°ã—ã„ã‚²ãƒ¼ãƒ ã§lastPlayedTimeã‚’ãƒªã‚»ãƒƒãƒˆ
                heatClickMultiplier: 1.0, // æ–°ã—ã„ã‚²ãƒ¼ãƒ ã§ãƒªã‚»ãƒƒãƒˆ
                lastClickTime: Date.now(), // æ–°ã—ã„ã‚²ãƒ¼ãƒ ã§ãƒªã‚»ãƒƒãƒˆ
                selectedBatchAmount: 1, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒãƒƒãƒè³¼å…¥é‡ã«ãƒªã‚»ãƒƒãƒˆ
                upgrades: initialUpgrades,
                volume: 0.5, // éŸ³é‡ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ
                inventory: {}, // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’ãƒªã‚»ãƒƒãƒˆ
                planetExcavationCooldowns: {} // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            };

            // ç†±ã‚¯ãƒªãƒƒã‚«ãƒ¼ã®æœ€å¤§å€ç‡ã‚’ãƒªã‚»ãƒƒãƒˆ
            MAX_HEAT_CLICK_MULTIPLIER = 2.0;

            if (strongStart) {
                // ãƒœãƒ¼ãƒŠã‚¹ã¯strongStartLevelã§ã‚¹ã‚±ãƒ¼ãƒ«
                // ãƒ¬ãƒ™ãƒ«0ï¼ˆæœ€åˆã®å¼·åŠ›ãªã‚¹ã‚¿ãƒ¼ãƒˆï¼‰ã¯å€ç‡1.0ã‚’æ„å‘³
                // ãƒ¬ãƒ™ãƒ«1ã¯å€ç‡1.1ãªã©ã‚’æ„å‘³
                const bonusMultiplier = 1 + (newStrongStartLevel * 0.1);

                gameState.energy = 1000 * bonusMultiplier;
                gameState.clickPower = 10 * bonusMultiplier;
                gameState.autoClickPower = 1 * bonusMultiplier;

                // å¼·åŠ›ãªã‚¹ã‚¿ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ã€é€šå¸¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã«åˆæœŸãƒ¬ãƒ™ãƒ«ã‚’é©ç”¨
                for (const key in gameState.upgrades) {
                    if (gameState.upgrades[key].maxLevel !== 1 && gameState.upgrades[key].excavationCooldown) { // ä¸€å›é™ã‚Šã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã«ã®ã¿ãƒœãƒ¼ãƒŠã‚¹ã‚’é©ç”¨
                        const initialLevel = key === 'mercury' ? 5 : (key === 'venus' ? 2 : 0); // ç‰¹å®šã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®åŸºæœ¬ãƒ¬ãƒ™ãƒ«
                        const calculatedLevel = Math.floor(initialLevel * bonusMultiplier);

                        if (calculatedLevel > 0) { // ãƒ¬ãƒ™ãƒ«ãŒæ­£ã®å ´åˆã«ã®ã¿é©ç”¨
                            gameState.upgrades[key].level = calculatedLevel;
                            // æ–°ã—ã„ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ã‚³ã‚¹ãƒˆãŒå†è¨ˆç®—ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
                            // initialCostãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãã‚Œã‚’è¨ˆç®—ã®åŸºæº–ã¨ã—ã¦ä½¿ç”¨ã—ã€ãã†ã§ãªã„å ´åˆã¯ç¾åœ¨ã®ã‚³ã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
                            // ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒæœ€åˆã«0ã§ã‚ã£ãŸå ´åˆã«ã€æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã®ã‚³ã‚¹ãƒˆãŒæ­£ã—ããƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚
                            gameState.upgrades[key].cost = Math.floor((gameState.upgrades[key].initialCost || gameState.upgrades[key].cost) * Math.pow(1.5, calculatedLevel));
                            gameState.clickPower += gameState.upgrades[key].clickBonus * calculatedLevel;
                            gameState.autoClickPower += gameState.upgrades[key].autoBonus * calculatedLevel;
                        }
                    }
                }
            }
            // ãƒªã‚»ãƒƒãƒˆå¾Œã«ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¨­å®šã‚’æ›´æ–°
            audioElement.volume = gameState.volume;
            volumeSlider.value = gameState.volume * 100;
            updateSpeakerIcon(audioElement.volume, audioElement.muted);

            updateDisplay();
            renderUpgrades(); // ãƒªã‚»ãƒƒãƒˆå¾Œã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            hideModal(confirmationModal);
            hideModal(settingsModal); // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            hideModal(upgradesSidebarModal); // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            hideModal(releaseNotesModal); // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            hideModal(creditsModal); // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            hideModal(inventoryModal); // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            hideModal(excavationModal); // æ¡æ˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            // ãƒªã‚»ãƒƒãƒˆå¾Œã«ã‚²ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æˆ»ã‚‹
            showSection('game');
            checkBreakthroughMenuVisibility(); // ãƒªã‚»ãƒƒãƒˆå¾Œã‚‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºã‚’ãƒã‚§ãƒƒã‚¯
        }

        /**
         * é™ç•Œçªç ´ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
         * ã„ãšã‚Œã‹ã®é™ç•Œçªç ´ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒè³¼å…¥æ¸ˆã¿ã€ã¾ãŸã¯è³¼å…¥å¯èƒ½ï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ã‚¢ã‚¤ãƒ†ãƒ ãŒè¶³ã‚Šã¦ã„ã‚‹ï¼‰ã§ã‚ã‚Œã°è¡¨ç¤ºã—ã¾ã™ã€‚
         */
        function checkBreakthroughMenuVisibility() {
            let shouldShow = false;
            for (const key in gameState.upgrades) {
                const upgrade = gameState.upgrades[key];
                if (upgrade.type === 'breakthrough') {
                    if (upgrade.level > 0) { // æ—¢ã«è³¼å…¥æ¸ˆã¿
                        shouldShow = true;
                        break;
                    }
                    // è³¼å…¥å¯èƒ½ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                    const { totalEnergyCost, totalItemCost, levelsBought } = calculateBatchCostAndEffects(key, 1); // 1ãƒ¬ãƒ™ãƒ«è³¼å…¥ã§ãƒã‚§ãƒƒã‚¯
                    if (levelsBought > 0 && totalEnergyCost <= gameState.energy) {
                        let canAffordItems = true;
                        if (upgrade.itemCost) {
                            for (const itemKey in upgrade.itemCost) {
                                if ((gameState.inventory[itemKey] || 0) < upgrade.itemCost[itemKey]) {
                                    canAffordItems = false;
                                    break;
                                }
                            }
                        }
                        if (canAffordItems) {
                            shouldShow = true;
                            break;
                        }
                    }
                }
            }

            if (shouldShow) {
                breakthroughMenuLink.style.display = 'block';
            } else {
                breakthroughMenuLink.style.display = 'none';
            }
        }

        // --- UIé–¢æ•° ---

        /**
         * ç‰¹å®šã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã€ä»–ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã™ã€‚
         * @param {string} sectionId - è¡¨ç¤ºã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®IDã€‚
         */
        function showSection(sectionId) {
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
            sidebar.classList.remove('open'); // é¸æŠå¾Œã«å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
            hideModal(upgradesSidebarModal); // ãƒ¡ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            hideModal(settingsModal); // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            hideModal(releaseNotesModal); // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            hideModal(creditsModal); // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            hideModal(inventoryModal); // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            hideModal(excavationModal); // æ¡æ˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
        }

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã€ãã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨­å®šã—ã¾ã™ã€‚
         * @param {HTMLElement} modalElement - ãƒ¢ãƒ¼ãƒ€ãƒ«DOMè¦ç´ ã€‚
         * @param {string} message - ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‚
         * @param {function} confirmCallback - ç¢ºèªãƒœã‚¿ãƒ³ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
         * @param {function} cancelCallback - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
         * @param {string} confirmButtonText - ç¢ºèªãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã€‚
         * @param {string} confirmButtonClass - ç¢ºèªãƒœã‚¿ãƒ³ã®èƒŒæ™¯ã®Tailwindã‚¯ãƒ©ã‚¹ã€‚
         * @param {string} cancelButtonText - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã€‚
         */
        function showGenericModal(modalElement, message, confirmCallback, cancelCallback, confirmButtonText = 'ã¯ã„', confirmButtonClass = 'bg-red-600 hover:bg-red-700', cancelButtonText = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«') {
            if (modalElement === confirmationModal) {
                modalMessage.innerHTML = message; // innerHTMLã‚’ä½¿ç”¨
                // ãƒœã‚¿ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                modalConfirmButton.style.display = 'inline-block';
                modalConfirmButton.disabled = false;
                modalConfirmButton.textContent = confirmButtonText;
                modalConfirmButton.className = 'modal-button confirm ' + confirmButtonClass;

                modalCancelButton.textContent = cancelButtonText;
                modalCancelButton.style.display = 'inline-block'; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
            }

            currentConfirmCallback = confirmCallback;
            currentCancelCallback = cancelCallback;

            modalElement.classList.add('open');
        }

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã—ã¾ã™ã€‚
         * @param {HTMLElement} modalElement - éè¡¨ç¤ºã«ã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«DOMè¦ç´ ã€‚
         */
        function hideModal(modalElement) {
            modalElement.classList.remove('open');
            currentConfirmCallback = null;
            currentCancelCallback = null;

            // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’éè¡¨ç¤ºæ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ
            if (modalElement === confirmationModal) {
                modalConfirmButton.style.display = 'inline-block';
                modalConfirmButton.disabled = false;
                modalCancelButton.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
                // å°†æ¥ã®ç”¨é€”ã®ãŸã‚ã«ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¯ãƒ©ã‚¹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ (ä¾‹: ãƒ‡ãƒ¼ã‚¿å‰Šé™¤)
                modalConfirmButton.textContent = 'ã¯ã„ã€å‰Šé™¤ã—ã¾ã™'; // å‰Šé™¤ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                modalConfirmButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700', 'bg-green-600', 'hover:bg-green-700', 'bg-blue-600', 'hover:bg-blue-700', 'bg-red-800', 'hover:bg-red-900');
                modalConfirmButton.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        /**
         * ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
         */
        function renderReleaseNotes() {
            releaseNotesContent.innerHTML = ''; // ä»¥å‰ã®ãƒãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
            releaseNotesData.forEach(release => {
                const releaseItem = document.createElement('div');
                releaseItem.className = 'release-notes-item';
                releaseItem.innerHTML = `
                    <h4>${release.version} (${release.date})</h4>
                    <p>${release.notes}</p>
                `;
                releaseNotesContent.appendChild(releaseItem);
            });
        }

        /**
         * ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
         */
        function renderCredits() {
            creditsContent.innerHTML = `
                <div class="credits-item">
                    <h4>ä½œè€…</h4>
                    <p>Minntelia</p>
                </div>
                <div class="credits-item">
                    <h4>éŸ³æ¥½</h4>
                    <p>â€œEdgeworth Kuiperveldâ€ by Akira Hata</p>
                </div>
            `;
        }

        /**
         * å¤šæ®µéšã®å‰Šé™¤ç¢ºèªãƒ­ã‚¸ãƒƒã‚¯ã‚’å‡¦ç†ã—ã¾ã™ã€‚
         */
        function confirmDeleteData() {
            // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹å‰ã«è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            hideModal(settingsModal);

            if (confirmationStep === 0) {
                showGenericModal(confirmationModal, "æœ¬å½“ã«ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã‚Œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚", confirmDeleteData, () => { confirmationStep = 0; hideModal(confirmationModal); settingsModal.classList.add('open'); }, 'ã¯ã„ã€å‰Šé™¤ã—ã¾ã™', 'bg-red-600 hover:bg-red-700');
                confirmationStep++;
            } else if (confirmationStep === 1) {
                showGenericModal(confirmationModal, "æœ€çµ‚ç¢ºèª: æœ¬å½“ã«æœ¬å½“ã«ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", confirmDeleteData, () => { confirmationStep = 0; hideModal(confirmationModal); settingsModal.classList.add('open'); }, 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ï¼', 'bg-yellow-600 hover:bg-yellow-700'); // è¿½åŠ è­¦å‘Šã®ãŸã‚ã«è‰²ã‚’å¤‰æ›´
                confirmationStep++;
            } else if (confirmationStep === 2) {
                showGenericModal(confirmationModal, "æœ€å¾Œã®ç¢ºèª: ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦å¤±ã‚ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ", confirmDeleteData, () => { confirmationStep = 0; hideModal(confirmationModal); settingsModal.classList.add('open'); }, 'ç¢ºèªã—ã¦å‰Šé™¤ï¼', 'bg-red-800 hover:bg-red-900'); // ã•ã‚‰ã«å¼·ã„è­¦å‘Šè‰²
                confirmationStep++;
            } else if (confirmationStep === 3) {
                resetGame(false); // å®Œå…¨ãªãƒªã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œï¼ˆå¼·åŠ›ãªã‚¹ã‚¿ãƒ¼ãƒˆã§ã¯ãªã„ï¼‰
                confirmationStep = 0; // æ¬¡å›ã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
                hideModal(confirmationModal);
                hideModal(settingsModal); // å®Œå…¨ãªãƒªã‚»ãƒƒãƒˆå¾Œã«è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            }
        }

        /**
         * ãƒªãƒ“ãƒƒã‚°ãƒãƒ³ç¢ºèªãƒ­ã‚¸ãƒƒã‚¯ã‚’å‡¦ç†ã—ã¾ã™ã€‚
         */
        function confirmRebigBang() {
            const requiredEnergy = getStrongStartCurrentCost();
            if (gameState.energy < requiredEnergy) {
                showGenericModal(confirmationModal, `ãƒªãƒ“ãƒƒã‚°ãƒãƒ³ã«ã¯ ${formatNumber(requiredEnergy)} ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå¿…è¦ã§ã™ã€‚ç¾åœ¨ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¯ ${formatNumber(gameState.energy)} ã§ã™ã€‚`, null, () => hideModal(confirmationModal), 'OK', 'bg-blue-600 hover:bg-blue-700', 'é–‰ã˜ã‚‹');
                modalConfirmButton.style.display = 'none'; // OKãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œé–‰ã˜ã‚‹ã€ã®ã¿ã‚¯ãƒªãƒƒã‚¯
                return;
            }

            showGenericModal(confirmationModal, `ãƒªãƒ“ãƒƒã‚°ãƒãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã€ãƒ¬ãƒ™ãƒ« ${gameState.strongStartLevel + 1} ã®ãƒœãƒ¼ãƒŠã‚¹ä»˜ãã§é–‹å§‹ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`,
                () => { // ç¢ºèªã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    resetGame(true);
                    hideModal(confirmationModal);
                },
                () => { // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    hideModal(confirmationModal);
                },
                'é–‹å§‹ï¼',
                'bg-green-600 hover:bg-green-700'
            );
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

        // æ˜Ÿã®ã‚¯ãƒªãƒƒã‚«ãƒ¼
        starClicker.addEventListener('click', clickStar);

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®ãƒˆã‚°ãƒ«
        menuButton.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ (ãƒ¢ãƒ¼ãƒ€ãƒ«/ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨)
        navLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const sectionId = event.target.dataset.section;
                const modalId = event.target.dataset.modal;
                const action = event.target.dataset.action;
                const scrollToTarget = event.target.dataset.scrollTo; // æ–°ã—ã„å±æ€§

                if (sectionId) {
                    showSection(sectionId);
                } else if (modalId === 'settings-modal') {
                    settingsModal.classList.add('open');
                } else if (modalId === 'upgrades-sidebar-modal') {
                    upgradesSidebarModal.classList.add('open');
                    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è©¦ã¿ã‚‹å‰ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
                    renderUpgrades();
                    // ãƒãƒƒãƒè³¼å…¥ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
                    updateBatchCycleButton();
                    if (scrollToTarget) {
                        // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                        setTimeout(() => {
                            const targetElement = document.getElementById(scrollToTarget);
                            if (targetElement) {
                                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 300); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³æ™‚é–“ã«åˆã‚ã›ã‚‹
                    }
                } else if (modalId === 'inventory-modal') {
                    inventoryModal.classList.add('open');
                    renderInventory(); // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’è¡¨ç¤º
                } else if (modalId === 'excavation-modal') {
                    // æ¡æ˜ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒè³¼å…¥æ¸ˆã¿ã®å ´åˆã®ã¿é–‹ã
                    if (gameState.upgrades.excavationLicense && gameState.upgrades.excavationLicense.level > 0) {
                        excavationModal.classList.add('open');
                        renderExcavationPlanets(); // æ¡æ˜æƒ‘æ˜Ÿã‚’è¡¨ç¤º
                    } else {
                        showGenericModal(confirmationModal, "æƒ‘æ˜Ÿæ¡æ˜æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Œæ¡æ˜ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚", null, () => hideModal(confirmationModal), 'OK', 'bg-blue-600 hover:bg-blue-700', 'é–‰ã˜ã‚‹');
                        modalConfirmButton.style.display = 'none';
                    }
                }
                else if (action === 'rebig-bang') {
                    confirmRebigBang();
                }
                sidebar.classList.remove('open'); // é¸æŠå¾Œã«ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
            });
        });

        // ãƒãƒƒãƒè³¼å…¥ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        batchCycleButton.addEventListener('click', () => {
            let currentIndex = batchAmounts.indexOf(gameState.selectedBatchAmount);
            let nextIndex = (currentIndex + 1) % batchAmounts.length;
            gameState.selectedBatchAmount = batchAmounts[nextIndex];
            updateBatchCycleButton();
            renderUpgrades(); // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ã€è³¼å…¥ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
        });

        /**
         * ãƒãƒƒãƒè³¼å…¥ã‚µã‚¤ã‚¯ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚
         */
        function updateBatchCycleButton() {
            if (gameState.selectedBatchAmount === 'max') {
                batchCycleButton.textContent = 'è³¼å…¥é‡: Max';
            } else {
                batchCycleButton.textContent = `è³¼å…¥é‡: x${gameState.selectedBatchAmount}`;
            }
        }


        // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
        closeUpgradesSidebarButton.addEventListener('click', () => {
            hideModal(upgradesSidebarModal);
        });

        // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closeInventoryModal.addEventListener('click', () => {
            hideModal(inventoryModal);
        });

        // æ¡æ˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closeExcavationModal.addEventListener('click', () => {
            hideModal(excavationModal);
        });

        // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
        releaseNotesButton.addEventListener('click', () => {
            hideModal(settingsModal); // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’é–‹ãã¨ãã«è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            releaseNotesModal.classList.add('open');
            renderReleaseNotes(); // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
        });

        creditsButton.addEventListener('click', () => {
            hideModal(settingsModal); // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’é–‹ãã¨ãã«è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            creditsModal.classList.add('open');
            renderCredits(); // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’è¡¨ç¤º
        });

        closeReleaseNotesModalButton.addEventListener('click', () => {
            hideModal(releaseNotesModal);
        });

        closeCreditsModalButton.addEventListener('click', () => {
            hideModal(creditsModal);
        });

        deleteDataButton.addEventListener('click', () => {
            confirmationStep = 0; // å‰Šé™¤ç¢ºèªã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ
            confirmDeleteData();
        });

        closeSettingsModalButton.addEventListener('click', () => {
            hideModal(settingsModal);
        });

        // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ãƒ­ãƒ¼ã‚ºãƒœã‚¿ãƒ³ (ç¢ºèªã€è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã€æ–°ã—ã„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚µã‚¤ãƒ‰ãƒãƒ¼ã€ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«)
        modalCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
                hideModal(button.closest('.modal') || button.closest('.upgrades-sidebar'));
            });
        });

        // æ±ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³ãƒªã‚¹ãƒŠãƒ¼
        modalConfirmButton.addEventListener('click', () => {
            if (currentConfirmCallback) {
                currentConfirmCallback();
            }
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å›ºæœ‰ã®çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆã¯hideModalã§å‡¦ç†ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ
        });

        modalCancelButton.addEventListener('click', () => {
            if (currentCancelCallback) {
                currentCancelCallback();
            }
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å›ºæœ‰ã®çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆã¯hideModalã§å‡¦ç†ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ
        });

        // éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒªã‚¹ãƒŠãƒ¼
        volumeSlider.addEventListener('input', () => {
            const volume = parseFloat(volumeSlider.value) / 100;
            audioElement.volume = volume;
            if (volume > 0) {
                audioElement.muted = false;
                lastVolumeBeforeMute = volume; // ãƒŸãƒ¥ãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆã€æœ€å¾Œã®éŸ³é‡ã‚’æ›´æ–°
            }
            updateSpeakerIcon(audioElement.volume, audioElement.muted);
        });

        speakerIcon.addEventListener('click', () => {
            if (audioElement.muted) {
                audioElement.muted = false;
                // ä»¥å‰ã®éŸ³é‡ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆä»¥å‰ã®éŸ³é‡ãŒãªã‘ã‚Œã°ï¼‰ã‚’å¾©å…ƒ
                audioElement.volume = lastVolumeBeforeMute > 0 ? lastVolumeBeforeMute : 0.5;
                volumeSlider.value = audioElement.volume * 100;
                audioElement.play().catch(e => console.error("ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤æ™‚ã®è‡ªå‹•å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:", e)); // ãƒŸãƒ¥ãƒ¼ãƒˆã•ã‚Œã¦ã„ãŸå ´åˆã€å†ç”Ÿã‚’è©¦ã¿ã‚‹
            } else {
                lastVolumeBeforeMute = audioElement.volume; // ãƒŸãƒ¥ãƒ¼ãƒˆã™ã‚‹å‰ã«ç¾åœ¨ã®éŸ³é‡ã‚’ä¿å­˜
                audioElement.muted = true;
                volumeSlider.value = 0; // ãƒŸãƒ¥ãƒ¼ãƒˆæ™‚ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’0ã«ç§»å‹•
            }
            updateSpeakerIcon(audioElement.volume, audioElement.muted);
        });

        // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ›´æ–°ç”¨ã®å®šæœŸçš„ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
        setInterval(() => {
            updateExcavationCooldownDisplay(); // This now mainly updates visibility of the wrapper
            if (excavationModal.classList.contains('open')) {
                updateExcavationPlanetButtons(); // Only update planet buttons if excavation modal is open
            }
        }, 500); // 500msã”ã¨ã«æ›´æ–°

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–
        window.onload = async () => {
            await initDb();
            await loadGame();
            renderUpgrades(); // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã®åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

            // ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‹ã‚‰ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¨­å®šã‚’åˆæœŸåŒ–
            audioElement.volume = gameState.volume;
            volumeSlider.value = gameState.volume * 100;
            updateSpeakerIcon(audioElement.volume, audioElement.muted);
            // éŸ³æ¥½ã®å†ç”Ÿã‚’è©¦ã¿ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
            audioElement.play().catch(e => {
                console.warn("è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚éŸ³æ¥½ã¯æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¾‹ï¼šæ˜Ÿã®ã‚¯ãƒªãƒƒã‚¯ï¼‰ã§é–‹å§‹ã•ã‚Œã¾ã™ã€‚", e);
                // è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã€åˆæœŸçŠ¶æ…‹ãŒã“ã‚Œã‚’åæ˜ ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
                audioElement.muted = true; // å†ç”Ÿã§ããªã‹ã£ãŸå ´åˆã€ãƒŸãƒ¥ãƒ¼ãƒˆã¨ã—ã¦ãƒãƒ¼ã‚¯
                volumeSlider.value = 0;
                updateSpeakerIcon(0, true);
            });

            setInterval(autoClickLoop, 100); // 100msã”ã¨ã«è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯
            setInterval(checkHeatClickerReset, 500); // 500msã”ã¨ã«ãƒ’ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚«ãƒ¼ã®ãƒªã‚»ãƒƒãƒˆã‚’ç¢ºèª
            // åˆæœŸã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
            showSection('game'); // ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚²ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
        };
    </script>
</body>
</html>
