<label style="position:absolute;left:10px;top:10px;z-index:10;background:#fff8;padding:4px;border-radius:8px;">
  アニメーション速度
  <input id="speed-range" type="range" min="0.1" max="100" step="0.01" value="1" style="vertical-align:middle;">
  <span id="speed-value">1.00</span>x
</label>
<canvas id="bg-canvas" width="600" height="800" style="display:block; margin:0 auto; background:#87ceeb;"></canvas>
<script>
const canvas = document.getElementById('bg-canvas');
const ctx = canvas.getContext('2d');

let speedMultiplier = 1;
const speedRange = document.getElementById('speed-range');
const speedValue = document.getElementById('speed-value');
speedRange.addEventListener('input', () => {
    speedMultiplier = parseFloat(speedRange.value);
    speedValue.textContent = speedMultiplier.toFixed(2);
});

let offsetSky = 0;
let offsetMount = 250;
let offsetMountFar = 200; // 追加: 奥の山用
let offsetGround = 0;

let groundLayers = [
    { baseY: 650, height: 100, color: '#00e60b', offset: 0, speed: 0.1 },
    { baseY: 700, height: 100, color: '#00b509', offset: 0, speed: 0.07 },
    { baseY: 750, height: 100, color: '#008a06', offset: 0, speed: 0.04 }
];

// 雲の設定
let clouds = [
    { x: 100, y: 80, size: 40, speedX: 1, speedY: 0.05 },
    { x: 400, y: 120, size: 60, speedX: 0.2, speedY: 0.03 },
    { x: 650, y: 60, size: 30, speedX: 0.4, speedY: 0.07 }
];
let extraClouds = []; // 追加雲用
const maxExtraClouds = 20; // 最大追加雲数
let frameCount = 0; // フレームカウンタ
const cloudAddInterval = 200; // 何フレームごとに追加するか

function drawCloud(cloud) {
    ctx.save();
    ctx.globalAlpha = 0.7;
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.ellipse(cloud.x, cloud.y, cloud.size, cloud.size * 0.6, 0, 0, Math.PI * 2);
    ctx.ellipse(cloud.x + cloud.size * 0.6, cloud.y + 5, cloud.size * 0.7, cloud.size * 0.4, 0, 0, Math.PI * 2);
    ctx.ellipse(cloud.x - cloud.size * 0.6, cloud.y + 8, cloud.size * 1, cloud.size * 1, 0, 0, Math.PI * 2);
    ctx.closePath();
    ctx.fill();
    ctx.globalAlpha = 1.0;
    ctx.restore();
}

let stars = [];
const STAR_COUNT = 200;
for (let i = 0; i < STAR_COUNT; i++) {
    stars.push({
        x: Math.random() * 600,
        y: Math.random() * 800,
        r: Math.random() * 1.5 + 0.5,
        phase: Math.random() * Math.PI * 2,
        speed: Math.random() * 0.03 + 0.01
    });
}

function drawStars(alpha) {
    ctx.save();
    ctx.globalAlpha = alpha;
    for (let star of stars) {
        // キラキラ点滅
        let blink = 0.7 + 0.3 * Math.sin(performance.now() * star.speed + star.phase);
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.r * blink, 0, Math.PI * 2);
        ctx.fillStyle = "#fff";
        ctx.shadowColor = "#fff";
        ctx.shadowBlur = 8 * blink;
        ctx.fill();
    }
    ctx.globalAlpha = 1.0;
    ctx.restore();
}

function drawBackground(offsetSky, offsetMount, offsetMountFar, groundLayers, clouds, extraClouds) {
    // 空（高さで色を変化）
    // 下: #87ceeb, 中: #1a2340, 上: #0a0a18（真っ暗）
    let startDarkenHeight = 5000;
    let maxSky = 30000;
    let fadeCloudStart = 50000;
    let fadeCloudEnd = 60000;
    let t = 0;
    if (offsetSky > startDarkenHeight) {
        t = Math.min((offsetSky - startDarkenHeight) / (maxSky - startDarkenHeight), 1);
    }
    function lerp(a, b, t) { return a + (b - a) * t; }
    // 通常の空色
    let r = Math.round(lerp(135, 26, t));
    let g = Math.round(lerp(206, 35, t));
    let b = Math.round(lerp(235, 64, t));
    // 真っ暗への補間
    let t2 = 0;
    if (offsetSky > fadeCloudStart) {
        t2 = Math.min((offsetSky - fadeCloudStart) / (fadeCloudEnd - fadeCloudStart), 1);
        r = Math.round(lerp(r, 10, t2));
        g = Math.round(lerp(g, 10, t2));
        b = Math.round(lerp(b, 24, t2));
    }
    ctx.fillStyle = `rgb(${r},${g},${b})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 星のフェードイン
    if (offsetSky > fadeCloudStart) {
        drawStars(t2);
    }

    // 雲のフェードアウト
    let cloudAlpha = 1;
    if (offsetSky > fadeCloudStart) {
        cloudAlpha = 1 - t2;
    }

    // 雲
    ctx.save();
    ctx.globalAlpha = cloudAlpha;
    for (let cloud of clouds) {
        drawCloud(cloud);
    }
    for (let cloud of extraClouds) {
        drawCloud(cloud);
    }
    ctx.globalAlpha = 1.0;
    ctx.restore();

    // 遠景の山（薄い色・高い位置）
    ctx.fillStyle = '#b0c48c';
    ctx.beginPath();
    ctx.moveTo(0, 180 + offsetMountFar);
    ctx.lineTo(100, 100 + offsetMountFar);
    ctx.lineTo(250, 200 + offsetMountFar);
    ctx.lineTo(400, 120 + offsetMountFar);
    ctx.lineTo(550, 210 + offsetMountFar);
    ctx.lineTo(600, 170 + offsetMountFar);
    ctx.lineTo(800, 200 + offsetMountFar);
    ctx.lineTo(800, 600 + offsetMountFar);
    ctx.lineTo(0, 600 + offsetMountFar);
    ctx.closePath();
    ctx.fill();

    // 近景の山（既存）
    ctx.fillStyle = '#6b8e23';
    ctx.beginPath();
    ctx.moveTo(0, 300 + offsetMount);
    ctx.lineTo(150, 180 + offsetMount);
    ctx.lineTo(300, 320 + offsetMount);
    ctx.lineTo(450, 200 + offsetMount);
    ctx.lineTo(600, 320 + offsetMount);
    ctx.lineTo(800, 250 + offsetMount);
    ctx.lineTo(800, 400 + offsetMount);
    ctx.lineTo(0, 400 + offsetMount);
    ctx.closePath();
    ctx.fill();

    // 地面（複数層）
    for (let layer of groundLayers) {
        ctx.fillStyle = layer.color;
        ctx.fillRect(0, layer.baseY + layer.offset, canvas.width, layer.height);
    }

    // 高度表示
    ctx.save();
    ctx.font = "bold 24px sans-serif";
    ctx.fillStyle = "#222";
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 3;
    let altitudeText = `高度: ${Math.floor(offsetSky)} m`;
    ctx.strokeText(altitudeText, 20, 60);
    ctx.fillText(altitudeText, 20, 60);
    ctx.restore();
}

function animate() {
    // 奥ほど遅く、手前ほど速く
    offsetSky += 1 * speedMultiplier;
    offsetMountFar += 0.03 * speedMultiplier; // 奥の山は遅く
    offsetMount += 0.1 * speedMultiplier;
    for (let layer of groundLayers) {
        layer.offset += layer.speed * speedMultiplier;
        // ループ（下に抜けたらリセット）
    }

    frameCount++;

    // 雲の移動
    for (let cloud of clouds) {
        cloud.x += cloud.speedX * speedMultiplier;
        cloud.y += cloud.speedY * speedMultiplier;
        if (cloud.x - cloud.size > canvas.width) cloud.x = -cloud.size;
        if (cloud.y < 30) cloud.y = 200 + Math.random() * 100;
        if (cloud.y > 250) cloud.y = 50 + Math.random() * 50;
    }

    // 高度が一定以上なら雲を徐々に増やす（何百フレームに1回）
    let cloudThreshold = 10000;
    if (
        offsetSky > cloudThreshold &&
        extraClouds.length < maxExtraClouds &&
        frameCount % cloudAddInterval === 0
    ) {
        extraClouds.push({
            x: Math.random() * canvas.width,
            y: Math.random() * 300 + 30,
            size: Math.random() * 40 + 20,
            speedX: Math.random() * 0.7 + 0.1,
            speedY: 0 // 初期値は0
        });
    }

    // 追加雲の移動
    for (let cloud of extraClouds) {
        cloud.x += cloud.speedX * speedMultiplier;
        // 高度10000以上なら下方向に動かす（降下速度を遅く）
        if (offsetSky > cloudThreshold) {
            cloud.speedY = Math.max(Math.abs(cloud.speedY), 0.02);
        }
        cloud.y += cloud.speedY * speedMultiplier;
        if (cloud.x - cloud.size > canvas.width) cloud.x = -cloud.size;
        if (cloud.y < 10) cloud.y = 300 + Math.random() * 100;
        if (cloud.y > 800) cloud.y = 30 + Math.random() * 100;
    }

    // 雲のフェードアウトが完了したらclouds/extraCloudsを消す
    let fadeCloudStart = 50000;
    let fadeCloudEnd = 60000;
    let t2 = 0;
    if (offsetSky > fadeCloudStart) {
        t2 = Math.min((offsetSky - fadeCloudStart) / (fadeCloudEnd - fadeCloudStart), 1);
        if (t2 >= 1) {
            clouds = [];
            extraClouds = [];
        }
    }

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBackground(offsetSky, offsetMount, offsetMountFar, groundLayers, clouds, extraClouds);

    requestAnimationFrame(animate);
}

animate();
</script>