<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çø„Éº„É≥Âà∂„Ç´„Éº„Éâ„Éê„Éà„É´„Ç≤„Éº„É†</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .game-container {
            background-color: #34495e;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            padding: 30px;
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }

        .game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .players-area, .enemies-area {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .character-card {
            background-color: #4a6a8c;
            border-radius: 12px;
            padding: 15px;
            width: 180px;
            text-align: center;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            cursor: pointer;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .character-card.active {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.5);
            border-color: #f1c40f; /* Active player highlight */
        }

        .character-card.selected {
            border-color: #3498db; /* Target selection highlight */
            background-color: #5b7da0;
        }

        .character-card.enemy {
            background-color: #8c4a4a;
            border-color: #e74c3c; /* Enemy highlight */
        }

        .character-card.enemy.selected {
            border-color: #f39c12; /* Selected enemy highlight */
            background-color: #a05b5b;
        }

        /* ÈÅ∏ÊäûÂèØËÉΩ„Å™„Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆÊñ∞„Åó„ÅÑ„Çπ„Çø„Ç§„É´ */
        .character-card.selectable-target {
            border-color: #3498db; /* Selectable target highlight */
            box-shadow: 0 0 15px #3498db, 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .character-card:hover:not(.active):not(.selected) {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .card-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #f39c12;
        }

        .card-stats {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .card-stats p {
            margin: 4px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-stats i {
            margin-right: 5px;
            color: #bdc3c7;
        }

        .hp-bar-container {
            width: 100%;
            background-color: #333;
            border-radius: 5px;
            height: 10px;
            margin-top: 8px;
            overflow: hidden;
        }

        .hp-bar {
            height: 100%;
            background-color: #27ae60;
            width: 100%; /* Initial width */
            border-radius: 5px;
            transition: width 0.3s ease-in-out;
        }

        .enemy-hp-bar {
            background-color: #e74c3c;
        }

        .game-log {
            background-color: #2c3e50;
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
            border: 1px solid #3b5066;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .log-entry {
            margin-bottom: 5px;
            line-height: 1.4;
            color: #ecf0f1;
        }

        .log-entry.damage { color: #e74c3c; }
        .log-entry.heal { color: #27ae60; }
        .log-entry.turn { color: #f1c40f; }
        .log-entry.game-over { color: #c0392b; font-weight: bold; }
        .log-entry.win { color: #2ecc71; font-weight: bold; }


        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .game-button {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }

        .game-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
        }

        .game-button:hover::before {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .game-button:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .game-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .game-button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2c3e50;
            border: 3px solid #f1c40f;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            z-index: 1000;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            color: #ecf0f1;
            display: none; /* Hidden by default */
            animation: fadeIn 0.3s ease-out;
        }

        .message-box button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }

        .message-box button:hover {
            background-color: #2980b9;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
            }

            .character-card {
                width: 140px;
                padding: 10px;
            }

            .card-name {
                font-size: 1em;
            }

            .card-stats {
                font-size: 0.8em;
            }

            .game-log {
                font-size: 0.8em;
            }

            .game-button {
                padding: 10px 20px;
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            .game-container {
                padding: 15px;
            }

            .character-card {
                width: 120px;
                padding: 8px;
            }

            .card-name {
                font-size: 0.9em;
            }

            .card-stats {
                font-size: 0.75em;
            }
            .players-area, .enemies-area {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>‚öîÔ∏è „Çø„Éº„É≥Âà∂„Ç´„Éº„Éâ„Éê„Éà„É´ ‚öîÔ∏è</h1>

        <div class="game-area">
            <h2>Êïµ üëπ</h2>
            <div id="enemiesArea" class="enemies-area">
                <!-- Êïµ„ÅÆ„Ç´„Éº„Éâ„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
            </div>

            <h2>Âë≥Êñπ üí™</h2>
            <div id="playersArea" class="players-area">
                <!-- Âë≥Êñπ„ÅÆ„Ç´„Éº„Éâ„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
            </div>
        </div>

        <div class="game-log" id="gameLog">
            <!-- „Ç≤„Éº„É†„É≠„Ç∞„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
        </div>

        <div class="controls">
            <button id="attackButton" class="game-button">ÊîªÊíÉÔºÅ</button>
            <button id="healButton" class="game-button">ÂõûÂæ©ÔºÅ</button>
            <button id="nextTurnButton" class="game-button" disabled>Ê¨°„ÅÆ„Çø„Éº„É≥</button>
            <button id="restartButton" class="game-button" style="background-color: #e74c3c;">ÊúÄÂàù„Åã„Çâ</button>
        </div>
    </div>

    <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <button id="closeMessageBox">OK</button>
    </div>

    <script>
        // „Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂü∫Êú¨„ÇØ„É©„Çπ
        class Character {
            constructor(name, maxHp, attack, healing, isPlayer = true) {
                this.name = name;
                this.maxHp = maxHp;
                this.currentHp = maxHp;
                this.attack = attack;
                this.healing = healing;
                this.isPlayer = isPlayer;
                this.element = null; // DOMË¶ÅÁ¥†„Çí‰øùÊåÅ
            }

            // „ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„Çã
            takeDamage(amount) {
                this.currentHp -= amount;
                if (this.currentHp < 0) {
                    this.currentHp = 0;
                }
                this.updateHpBar();
                // HP„Åå0„Å´„Å™„Å£„Åü„Çâ„Ç´„Éº„Éâ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÁÑ°Âäπ„Å´„Åô„Çã
                if (this.currentHp <= 0 && this.element) {
                    this.element.style.opacity = '0.5'; // ÈÄèÊòéÂ∫¶„Çí‰∏ã„Åí„Å¶ÁÑ°ÂäπÂåñ„ÇíÁ§∫„Åô
                    this.element.style.pointerEvents = 'none'; // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíÁÑ°ÂäπÂåñ
                    this.element.classList.remove('active', 'selected', 'selectable-target'); // „Éè„Ç§„É©„Ç§„Éà„ÇÇÂâäÈô§
                }
                return `${this.name} „ÅØ ${amount} „ÉÄ„É°„Éº„Ç∏Âèó„Åë„Åü„ÄÇÁèæÂú®„ÅÆHP: ${this.currentHp}`;
            }

            // ÂõûÂæ©„Åô„Çã
            heal(amount) {
                this.currentHp += amount;
                if (this.currentHp > this.maxHp) {
                    this.currentHp = this.maxHp;
                }
                this.updateHpBar();
                // HP„Åå0„Åã„ÇâÂõûÂæ©„Åó„Åü„Çâ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂÜçÂ∫¶ÊúâÂäπ„Å´„Åô„ÇãÔºàÂøÖË¶Å„Åß„ÅÇ„Çå„Å∞Ôºâ
                if (this.currentHp > 0 && this.element && this.element.style.pointerEvents === 'none') {
                    this.element.style.opacity = '1';
                    this.element.style.pointerEvents = 'auto';
                }
                return `${this.name} „ÅØ ${amount} ÂõûÂæ©„Åó„Åü„ÄÇÁèæÂú®„ÅÆHP: ${this.currentHp}`;
            }

            // HP„Éê„Éº„ÇíÊõ¥Êñ∞
            updateHpBar() {
                if (this.element) {
                    const hpBar = this.element.querySelector('.hp-bar');
                    const currentHpSpan = this.element.querySelector('.current-hp');
                    if (hpBar) {
                        const hpPercentage = (this.currentHp / this.maxHp) * 100;
                        hpBar.style.width = `${hpPercentage}%`;
                        if (hpPercentage < 30) {
                            hpBar.style.backgroundColor = '#e74c3c'; // Ëµ§
                        } else if (hpPercentage < 60) {
                            hpBar.style.backgroundColor = '#f1c40f'; // ÈªÑËâ≤
                        } else {
                            hpBar.style.backgroundColor = '#27ae60'; // Á∑ë
                        }
                    }
                    if (currentHpSpan) {
                        currentHpSpan.textContent = this.currentHp;
                    }
                }
            }

            // „Ç≠„É£„É©„ÇØ„Çø„Éº„Ç´„Éº„Éâ„ÇíÁîüÊàê
            createCardElement() {
                const card = document.createElement('div');
                card.classList.add('character-card');
                if (!this.isPlayer) {
                    card.classList.add('enemy');
                }
                card.dataset.name = this.name;

                card.innerHTML = `
                    <div class="card-name">${this.name}</div>
                    <div class="card-stats">
                        <p><i class="fas fa-heart"></i> HP: <span class="current-hp">${this.currentHp}</span> / ${this.maxHp}</p>
                        <p><i class="fas fa-fist-raised"></i> ÊîªÊíÉÂäõ: ${this.attack}</p>
                        <p><i class="fas fa-first-aid"></i> ÂõûÂæ©Âäõ: ${this.healing}</p>
                    </div>
                    <div class="hp-bar-container">
                        <div class="hp-bar ${this.isPlayer ? '' : 'enemy-hp-bar'}"></div>
                    </div>
                `;
                this.element = card;
                this.updateHpBar(); // ÂàùÊúüHP„Éê„Éº„ÇíË®≠ÂÆö
                return card;
            }
        }

        // „Ç≤„Éº„É†„ÅÆÁä∂ÊÖã„ÇíÁÆ°ÁêÜ„Åô„Çã„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
        const gameState = {
            players: [],
            enemies: [],
            currentPlayerIndex: 0,
            currentTurnPhase: 'player_action', // 'player_action', 'select_target', 'enemy_action'
            selectedAction: null, // 'attack' or 'heal'
            selectedTarget: null, // „Çø„Éº„Ç≤„ÉÉ„Éà„Å®„Å™„Çã„Ç≠„É£„É©„ÇØ„Çø„Éº
            gameOver: false,
        };

        // DOMË¶ÅÁ¥†
        const playersArea = document.getElementById('playersArea');
        const enemiesArea = document.getElementById('enemiesArea');
        const gameLog = document.getElementById('gameLog');
        const attackButton = document.getElementById('attackButton');
        const healButton = document.getElementById('healButton');
        const nextTurnButton = document.getElementById('nextTurnButton');
        const restartButton = document.getElementById('restartButton');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBox = document.getElementById('closeMessageBox');

        // „É°„ÉÉ„Çª„Éº„Ç∏„Éú„ÉÉ„ÇØ„Çπ„ÇíË°®Á§∫
        function showMessageBox(message, callback) {
            messageText.textContent = message;
            messageBox.style.display = 'block';
            const handleClose = () => {
                messageBox.style.display = 'none';
                closeMessageBox.removeEventListener('click', handleClose);
                if (callback) callback();
            };
            closeMessageBox.addEventListener('click', handleClose);
        }

        // „Ç≤„Éº„É†„É≠„Ç∞„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
        function addLog(message, type = '') {
            const entry = document.createElement('p');
            entry.classList.add('log-entry');
            if (type) {
                entry.classList.add(type);
            }
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            gameLog.prepend(entry); // ÊúÄÊñ∞„ÅÆ„É≠„Ç∞„Åå‰∏ä„Å´Êù•„Çã„Çà„ÅÜ„Å´
            gameLog.scrollTop = 0; // „Çπ„ÇØ„É≠„Éº„É´„Çí‰∏ÄÁï™‰∏ä„Å´„Åô„Çã
        }

        // „Ç≤„Éº„É†„ÅÆÂàùÊúüÂåñ
        function initializeGame() {
            // „Éó„É¨„Ç§„É§„Éº„ÇíÂÆöÁæ©
            gameState.players = [
                new Character('Ââ£Â£´', 100, 20, 10, true),
                new Character('È≠îÊ≥ï‰Ωø„ÅÑ', 80, 25, 5, true),
                new Character('ÂÉß‰æ∂', 90, 10, 20, true),
                new Character('ÁõóË≥ä', 70, 15, 15, true)
            ];

            // Êïµ„ÇíÂÆöÁæ©
            gameState.enemies = [
                new Character('„Ç¥„Éñ„É™„É≥', 60, 15, 0, false),
                new Character('„Çπ„É©„Ç§„É†', 40, 10, 0, false),
                new Character('„Ç™„Éº„ÇØ', 90, 20, 0, false)
            ];

            gameState.currentPlayerIndex = 0;
            gameState.currentTurnPhase = 'player_action';
            gameState.selectedAction = null;
            gameState.selectedTarget = null;
            gameState.gameOver = false;

            playersArea.innerHTML = '';
            enemiesArea.innerHTML = '';
            gameLog.innerHTML = '';

            // „Ç´„Éº„Éâ„ÇíDOM„Å´ËøΩÂä†
            gameState.players.forEach(player => {
                playersArea.appendChild(player.createCardElement());
            });
            gameState.enemies.forEach(enemy => {
                enemiesArea.appendChild(enemy.createCardElement());
            });

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂÜçË®≠ÂÆö
            setupEventListeners();
            updateButtonStates();
            addLog('„Ç≤„Éº„É†ÈñãÂßãÔºÅ', 'turn');
            startPlayerTurn();
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
        function setupEventListeners() {
            // Êó¢Â≠ò„ÅÆ„É™„Çπ„Éä„Éº„ÇíÂâäÈô§ („É™„Çπ„Çø„Éº„ÉàÊôÇ„Å´ÈáçË§á„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´)
            attackButton.onclick = null;
            healButton.onclick = null;
            nextTurnButton.onclick = null;
            restartButton.onclick = null;

            attackButton.onclick = () => selectAction('attack');
            healButton.onclick = () => selectAction('heal');
            nextTurnButton.onclick = endPlayerTurn;
            restartButton.onclick = () => {
                // confirm() „ÅÆ‰ª£„Çè„Çä„Å´ showMessageBox „Çí‰ΩøÁî®
                showMessageBox('Êú¨ÂΩì„Å´„Ç≤„Éº„É†„ÇíÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åô„ÅãÔºü', () => {
                    initializeGame();
                });
            };

            // „Ç≠„É£„É©„ÇØ„Çø„Éº„Ç´„Éº„Éâ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºà„Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏ÊäûÁî®Ôºâ
            document.querySelectorAll('.character-card').forEach(card => {
                card.onclick = null; // Êó¢Â≠ò„ÅÆ„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
                card.onclick = (event) => handleCardClick(event.currentTarget);
            });
        }

        // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateButtonStates() {
            if (gameState.gameOver) {
                attackButton.disabled = true;
                healButton.disabled = true;
                nextTurnButton.disabled = true;
                return;
            }

            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            if (!currentPlayer || currentPlayer.currentHp <= 0) {
                 attackButton.disabled = true;
                 healButton.disabled = true;
                 nextTurnButton.disabled = true;
                 return;
            }

            switch (gameState.currentTurnPhase) {
                case 'player_action':
                    attackButton.disabled = false;
                    healButton.disabled = false;
                    nextTurnButton.disabled = true;
                    break;
                case 'select_target':
                    attackButton.disabled = true;
                    healButton.disabled = true;
                    nextTurnButton.disabled = true;
                    break;
                case 'action_done':
                    attackButton.disabled = true;
                    healButton.disabled = true;
                    nextTurnButton.disabled = false;
                    break;
                default:
                    attackButton.disabled = true;
                    healButton.disabled = true;
                    nextTurnButton.disabled = true;
            }
        }

        // „Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆ„Éè„Ç§„É©„Ç§„Éà„Å®ÈÅ∏ÊäûÂèØËÉΩ„Å™„Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆ„Éè„Ç§„É©„Ç§„Éà„Çí„É™„Çª„ÉÉ„Éà
        function resetHighlights() {
            document.querySelectorAll('.character-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.character-card.selectable-target').forEach(card => {
                card.classList.remove('selectable-target');
            });
        }

        // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû
        function selectAction(action) {
            resetHighlights(); // ÂÖ®„Å¶„ÅÆ„Éè„Ç§„É©„Ç§„Éà„Çí„É™„Çª„ÉÉ„Éà
            gameState.selectedAction = action;
            gameState.currentTurnPhase = 'select_target';
            addLog(`${gameState.players[gameState.currentPlayerIndex].name} „Åå ${action === 'attack' ? 'ÊîªÊíÉ' : 'ÂõûÂæ©'} „ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇ„Çø„Éº„Ç≤„ÉÉ„Éà„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ`, 'turn');
            updateButtonStates();

            // ÈÅ∏ÊäûÂèØËÉΩ„Å™„Çø„Éº„Ç≤„ÉÉ„Éà„Çí„Éè„Ç§„É©„Ç§„Éà
            if (action === 'attack') {
                gameState.enemies.filter(e => e.currentHp > 0).forEach(enemy => {
                    // ‰øÆÊ≠£: enemy.classList.add -> enemy.element.classList.add
                    if (enemy.element) enemy.element.classList.add('selectable-target');
                });
            } else { // heal
                gameState.players.filter(p => p.currentHp > 0).forEach(player => {
                    // ‰øÆÊ≠£: player.classList.add -> player.element.classList.add
                    if (player.element) player.element.classList.add('selectable-target');
                });
            }
        }

        // „Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÂá¶ÁêÜ („Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû)
        function handleCardClick(cardElement) {
            if (gameState.currentTurnPhase !== 'select_target' || gameState.gameOver) {
                return;
            }

            const targetName = cardElement.dataset.name;
            let target = null;
            const isEnemyCard = cardElement.classList.contains('enemy');

            if (isEnemyCard) {
                target = gameState.enemies.find(e => e.name === targetName);
            } else {
                target = gameState.players.find(p => p.name === targetName);
            }

            if (!target || target.currentHp <= 0) {
                showMessageBox('„Åù„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà„ÅØÈÅ∏Êäû„Åß„Åç„Åæ„Åõ„ÇìÔºÅ');
                return;
            }

            // „Ç¢„ÇØ„Ç∑„Éß„É≥„Å´Âøú„Åò„Å¶„Çø„Éº„Ç≤„ÉÉ„Éà„ÇíÊ§úË®º
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            if (gameState.selectedAction === 'attack' && !isEnemyCard) {
                showMessageBox('ÊîªÊíÉ„ÅØÊïµ„Å´ÂØæ„Åó„Å¶„ÅÆ„ÅøË°å„Åà„Åæ„ÅôÔºÅ');
                return;
            }
            if (gameState.selectedAction === 'heal' && isEnemyCard) {
                showMessageBox('ÂõûÂæ©„ÅØÂë≥Êñπ„Å´ÂØæ„Åó„Å¶„ÅÆ„ÅøË°å„Åà„Åæ„ÅôÔºÅ');
                return;
            }

            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éº„Ç≤„ÉÉ„Éà„Çí„Éè„Ç§„É©„Ç§„Éà
            resetHighlights(); // ÈÅ∏ÊäûÂèØËÉΩ„Å™„Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇÇ„É™„Çª„ÉÉ„Éà
            cardElement.classList.add('selected');
            gameState.selectedTarget = target;

            performPlayerAction(currentPlayer, gameState.selectedAction, gameState.selectedTarget);
        }

        // „Éó„É¨„Ç§„É§„Éº„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÆüË°å
        function performPlayerAction(player, action, target) {
            if (!player || player.currentHp <= 0) return;

            let logMessage = '';
            if (action === 'attack') {
                const damage = player.attack + Math.floor(Math.random() * 5); // „É©„É≥„ÉÄ„É†ÊÄß
                logMessage = `${player.name} „ÅØ ${target.name} „Å´ ${damage} „ÉÄ„É°„Éº„Ç∏‰∏é„Åà„ÅüÔºÅ`;
                addLog(logMessage, 'damage');
                target.takeDamage(damage);
            } else if (action === 'heal') {
                const healing = player.healing + Math.floor(Math.random() * 3); // „É©„É≥„ÉÄ„É†ÊÄß
                logMessage = `${player.name} „ÅØ ${target.name} „Çí ${healing} ÂõûÂæ©„Åó„ÅüÔºÅ`;
                addLog(logMessage, 'heal');
                target.heal(healing);
            }

            gameState.currentTurnPhase = 'action_done';
            updateButtonStates();
            resetHighlights(); // „Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆüË°åÂæå„ÄÅÂÖ®„Å¶„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíËß£Èô§
            checkGameEnd();
        }

        // „Éó„É¨„Ç§„É§„Éº„ÅÆ„Çø„Éº„É≥„ÇíÈñãÂßã
        function startPlayerTurn() {
            if (gameState.gameOver) return;

            // HP„Åå0„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            let currentPlayer = gameState.players[gameState.currentPlayerIndex];
            let attempts = 0;
            const maxAttempts = gameState.players.length; // ÁÑ°Èôê„É´„Éº„ÉóÈò≤Ê≠¢„ÅÆ„Åü„ÇÅ
            while (currentPlayer && currentPlayer.currentHp <= 0 && attempts < maxAttempts) {
                gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
                currentPlayer = gameState.players[gameState.currentPlayerIndex];
                attempts++;
            }

            // ÂÖ®Âì°„ÅÆHP„Åå0„ÅÆÂ†¥Âêà„Ç≤„Éº„É†ÁµÇ‰∫Ü
            if (!currentPlayer || currentPlayer.currentHp <= 0) {
                addLog('„Åô„Åπ„Å¶„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅåË°åÂãï‰∏çËÉΩ„Åß„Åô„ÄÇÊïµ„ÅÆ„Çø„Éº„É≥„Å´Áßª„Çä„Åæ„Åô„ÄÇ', 'turn');
                setTimeout(performEnemyTurn, 1000);
                return;
            }

            addLog(`${currentPlayer.name} „ÅÆ„Çø„Éº„É≥„Åß„ÅôÔºÅ`, 'turn');
            // ÂÖ®„Å¶„ÅÆ„Éó„É¨„Ç§„É§„Éº„Ç´„Éº„Éâ„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('active');
            });
            // ÁèæÂú®„ÅÆ„Éó„É¨„Ç§„É§„Éº„Ç´„Éº„Éâ„Å´active„ÇØ„É©„Çπ„ÇíËøΩÂä†
            if (currentPlayer.element) {
                currentPlayer.element.classList.add('active');
            }

            gameState.currentTurnPhase = 'player_action';
            updateButtonStates();
        }

        // „Éó„É¨„Ç§„É§„Éº„ÅÆ„Çø„Éº„É≥„ÇíÁµÇ‰∫Ü
        function endPlayerTurn() {
            if (gameState.gameOver) return;

            // ÁèæÂú®„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíËß£Èô§
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            if (currentPlayer && currentPlayer.element) {
                currentPlayer.element.classList.remove('active');
            }

            // Ê¨°„ÅÆ„Éó„É¨„Ç§„É§„Éº„Å´Âàá„ÇäÊõø„Åà„Çã
            gameState.currentPlayerIndex++;
            if (gameState.currentPlayerIndex >= gameState.players.length) {
                // ÂÖ®„Å¶„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅåË°åÂãï„Åó„Åü„ÇâÊïµ„ÅÆ„Çø„Éº„É≥
                gameState.currentPlayerIndex = 0;
                addLog('„Éó„É¨„Ç§„É§„Éº„ÅÆ„Çø„Éº„É≥ÁµÇ‰∫ÜÔºÅÊïµ„ÅÆ„Çø„Éº„É≥„Åß„Åô„ÄÇ', 'turn');
                setTimeout(performEnemyTurn, 1000); // Êïµ„ÅÆ„Çø„Éº„É≥„ÇíÈñãÂßã
            } else {
                startPlayerTurn(); // Ê¨°„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆ„Çø„Éº„É≥„ÇíÈñãÂßã
            }
        }

        // Êïµ„ÅÆ„Çø„Éº„É≥„ÇíÂÆüË°å
        function performEnemyTurn() {
            if (gameState.gameOver) return;
            addLog('Êïµ„ÅÆ„Çø„Éº„É≥ÔºÅ', 'turn');

            const livePlayers = gameState.players.filter(p => p.currentHp > 0);
            const liveEnemies = gameState.enemies.filter(e => e.currentHp > 0);

            if (livePlayers.length === 0) {
                checkGameEnd(); // „Éó„É¨„Ç§„É§„Éº„ÅåÂÖ®ÊªÖ„Åó„Åü„Çâ„Ç≤„Éº„É†ÁµÇ‰∫Ü
                return;
            }
            if (liveEnemies.length === 0) {
                 checkGameEnd(); // Êïµ„ÅåÂÖ®ÊªÖ„Åó„Åü„Çâ„Ç≤„Éº„É†ÁµÇ‰∫Ü
                 return;
            }

            let actionsCompleted = 0;
            liveEnemies.forEach(enemy => {
                if (enemy.currentHp <= 0) return; // ÂÄí„Åï„Çå„ÅüÊïµ„ÅØË°åÂãï„Åó„Å™„ÅÑ

                // „É©„É≥„ÉÄ„É†„Å™„Éó„É¨„Ç§„É§„Éº„Çí„Çø„Éº„Ç≤„ÉÉ„Éà„Å´ÈÅ∏„Å∂
                const targetPlayer = livePlayers[Math.floor(Math.random() * livePlayers.length)];
                if (targetPlayer) {
                    const damage = enemy.attack + Math.floor(Math.random() * 5);
                    addLog(`${enemy.name} „ÅØ ${targetPlayer.name} „Å´ ${damage} „ÉÄ„É°„Éº„Ç∏‰∏é„Åà„ÅüÔºÅ`, 'damage');
                    targetPlayer.takeDamage(damage);
                }
                actionsCompleted++;
            });

            // „Åô„Åπ„Å¶„ÅÆÊïµ„ÅåË°åÂãï„ÇíÁµÇ„Åà„Åü„Çâ„Éó„É¨„Ç§„É§„Éº„ÅÆ„Çø„Éº„É≥„Å´Êàª„Çã
            // „Åü„Å†„Åó„ÄÅ„Åô„Åπ„Å¶„ÅÆÊïµ„ÅåÂÄí„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Ç≤„Éº„É†ÁµÇ‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„ÅÆ„Åø
            if (liveEnemies.length === actionsCompleted) {
                addLog('Êïµ„ÅÆ„Çø„Éº„É≥ÁµÇ‰∫ÜÔºÅ„Éó„É¨„Ç§„É§„Éº„ÅÆ„Çø„Éº„É≥„Å´Êàª„Çä„Åæ„Åô„ÄÇ', 'turn');
                setTimeout(startPlayerTurn, 1500); // „Éó„É¨„Ç§„É§„Éº„ÅÆ„Çø„Éº„É≥„ÇíÈñãÂßã
                checkGameEnd();
            } else {
                // Áîü„Åç„Å¶„ÅÑ„ÇãÊïµ„Åå„ÅÑ„Å™„ÅÑÂ†¥Âêà
                checkGameEnd();
            }
        }

        // „Ç≤„Éº„É†„ÅÆÁµÇ‰∫ÜÊù°‰ª∂„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkGameEnd() {
            const livePlayers = gameState.players.filter(p => p.currentHp > 0);
            const liveEnemies = gameState.enemies.filter(e => e.currentHp > 0);

            if (livePlayers.length === 0) {
                addLog('„Åô„Åπ„Å¶„ÅÆÂë≥Êñπ„ÅåÂÄí„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÔºÅ', 'game-over');
                showMessageBox('„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÔºÅ\n„Åô„Åπ„Å¶„ÅÆÂë≥Êñπ„ÅåÂÄí„Åï„Çå„Åæ„Åó„Åü„ÄÇ', () => {
                    gameState.gameOver = true;
                    updateButtonStates();
                });
            } else if (liveEnemies.length === 0) {
                addLog('„Åô„Åπ„Å¶„ÅÆÊïµ„ÇíÂÄí„Åó„Åæ„Åó„Åü„ÄÇÂãùÂà©ÔºÅ', 'win');
                showMessageBox('ÂãùÂà©ÔºÅ\n„Åô„Åπ„Å¶„ÅÆÊïµ„ÇíÂÄí„Åó„Åæ„Åó„ÅüÔºÅ', () => {
                    gameState.gameOver = true;
                    updateButtonStates();
                });
            }
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        window.onload = initializeGame;
    </script>
</body>
</html>