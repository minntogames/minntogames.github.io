# データ管理

キャラクター図鑑のデータ管理機能について説明します。

## データ管理画面

### 開き方
1. ハンバーガーメニュー（☰）を開く
2. 「データ管理」をクリック
3. データ管理ポップアップが表示されます

### 閉じ方
- ×ボタンをクリック
- Escキーを押す
- ポップアップ外をクリック

## エクスポート機能

データをJSONファイルとしてダウンロードできます。

### エクスポート可能なデータ

#### 1. キャラクターデータ
全てのキャラクター情報を含むJSONファイル。

**含まれる情報:**
- キャラクター基本情報
- 名前（日本語/英語）
- 世界、種族、戦闘スタイル、属性
- グループ
- 武器情報
- 関連キャラクター
- 関係情報
- カスタムタグ（紐付け情報）

**ファイル名:** `characters_YYYYMMDD_HHMMSS.json`

#### 2. カスタムタグデータ
全てのカスタムタグ情報を含むJSONファイル。

**含まれる情報:**
- タグID
- タグ名
- タグの色
- 作成日時
- 並び順
- タグごとの並び順設定
- タグごとのカスタム並び順

**ファイル名:** `custom_tags_YYYYMMDD_HHMMSS.json`

### エクスポート手順

#### キャラクターデータのエクスポート
1. データ管理画面を開く
2. 「キャラクターをエクスポート」ボタンをクリック
3. JSONファイルがダウンロードされます

#### カスタムタグのエクスポート
1. データ管理画面を開く
2. 「カスタムタグをエクスポート」ボタンをクリック
3. JSONファイルがダウンロードされます

### エクスポートファイルの形式

#### キャラクターデータ（例）
```json
{
  "version": "1.0",
  "exportDate": "2025-11-30T12:00:00.000Z",
  "characters": [
    {
      "id": 1,
      "name": {
        "ja": "アリス",
        "en": "Alice"
      },
      "world": {
        "ja": "ファンタジー世界",
        "en": "Fantasy World"
      },
      "race": ["人間"],
      "fightingStyle": ["近接"],
      "attribute": ["火"],
      "group": ["冒険者ギルド"],
      "weapon": {
        "ja": "エクスカリバー",
        "en": "Excalibur"
      },
      "weaponType": {
        "ja": "剣",
        "en": "Sword"
      },
      "relatedCharacters": [2, 3],
      "relationships": [
        {
          "charId": 2,
          "relation": "友人",
          "description": "幼馴染"
        }
      ],
      "customTags": [1, 2]
    }
  ]
}
```

#### カスタムタグデータ（例）
```json
{
  "version": "1.0",
  "exportDate": "2025-11-30T12:00:00.000Z",
  "tags": [
    {
      "id": 1,
      "name": "お気に入り",
      "color": "#ff6b6b",
      "createdAt": "2025-11-01T00:00:00.000Z",
      "order": 0
    }
  ],
  "tagSortOrders": {
    "1": "custom"
  },
  "tagCustomOrders": {
    "1": [5, 3, 1, 2, 4]
  }
}
```

## インポート機能

JSONファイルからデータを復元できます。

### インポート可能なデータ

#### 1. キャラクターデータ
エクスポートしたキャラクターデータを復元します。

#### 2. カスタムタグデータ
エクスポートしたカスタムタグデータを復元します。

### インポート手順

#### キャラクターデータのインポート
1. データ管理画面を開く
2. 「キャラクターをインポート」ボタンをクリック
3. ファイル選択ダイアログが開きます
4. JSONファイルを選択
5. 確認ダイアログが表示されます
6. 「インポート」をクリック
7. データが復元されます

#### カスタムタグのインポート
1. データ管理画面を開く
2. 「カスタムタグをインポート」ボタンをクリック
3. ファイル選択ダイアログが開きます
4. JSONファイルを選択
5. 確認ダイアログが表示されます
6. 「インポート」をクリック
7. データが復元されます

### インポート時の動作

#### マージモード
既存のデータに追加する形でインポートされます。

**重複処理:**
- キャラクター: ID が同じ場合は上書き
- カスタムタグ: ID が同じ場合は上書き

#### バージョン確認
ファイルのバージョンが確認され、互換性がチェックされます。

### 注意事項
- インポート前に必ず現在のデータをエクスポートしてバックアップ
- インポートは元に戻せません
- 大量データのインポートには時間がかかる場合があります

## データの削除

### 全データの削除

#### 手順
1. データ管理画面を開く
2. 「全データを削除」ボタンをクリック
3. 確認ダイアログが表示されます
4. 「削除」をクリック
5. 全てのデータが削除されます

#### 削除されるデータ
- 全てのキャラクターデータ
- 全てのカスタムタグデータ
- 全ての設定データ
- IndexedDB内の全データ
- localStorageの全データ

#### 注意事項
- **削除は元に戻せません**
- 削除前に必ずエクスポートしてバックアップ
- ページがリロードされます

### 個別データの削除

#### カスタムタグの削除
カスタムタグ管理画面から個別に削除できます。
詳細は [カスタムタグ](./custom-tags.md#タグの削除) を参照。

## データの保存先

### IndexedDB

ブラウザのIndexedDBに保存されます。

#### データベース構成
1. **CharactersDB**
   - オブジェクトストア: `characters`
   - キー: `id`
   - データ: キャラクター情報

2. **CustomTagsDB**
   - オブジェクトストア: `customTags`
   - キー: `id`
   - データ: カスタムタグ情報

#### 特徴
- 大容量データに対応（数MB〜数十MB）
- 高速なデータアクセス
- オフラインでも動作
- ブラウザごとに独立

### localStorage

設定データなどに使用されます。

#### 保存される情報
- 並び順設定 (`sortOrder`)
- カスタム並び順 (`customCharacterOrder`)
- タグごとの並び順 (`tagSortOrders`)
- タグごとのカスタム順 (`tagCustomOrders`)
- テーマ設定 (`theme`)
- 言語設定 (`language`)
- その他の設定

#### 特徴
- 小容量（数KB〜数MB）
- キー・バリュー形式
- 同期的アクセス
- ブラウザごとに独立

## バックアップ戦略

### 推奨バックアップ頻度

#### 定期バックアップ
- **毎月1回**: フルバックアップ（キャラクター + カスタムタグ）
- **毎週1回**: カスタムタグのみ（頻繁に変更する場合）

#### イベント時バックアップ
- 大量のデータを編集する前
- 新しいブラウザに移行する前
- OSをアップデートする前
- ブラウザのデータを削除する前

### バックアップファイルの管理

#### ファイル名規則
エクスポートファイルには自動的に日時が付与されます:
- `characters_20251130_120000.json`
- `custom_tags_20251130_120000.json`

#### 保存場所
- ローカルフォルダ: `ドキュメント/キャラ図鑑バックアップ/`
- クラウドストレージ: Google Drive、Dropboxなど
- 外部ストレージ: USBメモリ、外付けHDDなど

#### 世代管理
複数の世代を保持することを推奨:
- 最新
- 1週間前
- 1ヶ月前
- 3ヶ月前

### 復元手順

#### 通常の復元
1. バックアップファイルを用意
2. データ管理画面を開く
3. インポート機能を使用

#### 完全な復元（全データ削除後）
1. 全データを削除
2. キャラクターデータをインポート
3. カスタムタグデータをインポート
4. 設定を再設定（必要に応じて）

## ブラウザ間でのデータ移行

### 手順

#### エクスポート側（元のブラウザ）
1. 全データをエクスポート
   - キャラクターデータ
   - カスタムタグデータ
2. ファイルを保存

#### インポート側（新しいブラウザ）
1. 新しいブラウザでサイトを開く
2. データ管理画面を開く
3. エクスポートしたファイルをインポート
   - キャラクターデータ
   - カスタムタグデータ
4. 設定を再設定

### 注意事項
- 両方のブラウザで同じバージョンを使用
- 設定（テーマ、言語など）は手動で再設定が必要
- データ量が多い場合は時間がかかる

## トラブルシューティング

### エクスポートできない
1. ブラウザのダウンロード設定を確認
2. ポップアップブロックを無効化
3. ストレージ権限を確認
4. JavaScriptエラーがないか確認

### インポートできない
1. ファイル形式がJSONか確認
2. ファイルが破損していないか確認
3. ファイルサイズを確認（大きすぎないか）
4. ブラウザのコンソールでエラーを確認

### データが消えた
1. ブラウザのデータを削除していないか確認
2. プライベートモードを使用していないか確認
3. 別のブラウザやプロファイルを使用していないか確認
4. バックアップから復元

### インポート後にデータが反映されない
1. ページをリロード
2. キャッシュをクリア
3. IndexedDBを確認
4. もう一度インポート

### ファイルサイズが大きすぎる
1. 不要なデータを削除してからエクスポート
2. キャラクターデータとカスタムタグを分けてエクスポート
3. ブラウザの制限を確認

## セキュリティとプライバシー

### データの保護
- データはローカル（ブラウザ内）にのみ保存
- サーバーには送信されません
- 外部への通信なし

### エクスポートファイルの取り扱い
- エクスポートファイルには個人情報が含まれる可能性
- ファイルの共有には注意
- クラウドストレージに保存する場合は暗号化推奨

### ブラウザのプライバシー設定
- プライベートモードではデータが保存されない
- ブラウザのデータ削除機能で削除される
- サードパーティCookie設定の影響なし

## ベストプラクティス

### バックアップ習慣
1. 毎月1日にフルバックアップ
2. 大きな変更前にバックアップ
3. 複数の保存場所に保管

### ファイル管理
1. 日付付きフォルダで整理
2. 世代管理（最低3世代保持）
3. 定期的に古いバックアップを削除

### データ整理
1. 不要なカスタムタグを削除
2. 重複データを統合
3. 定期的にデータを見直し
